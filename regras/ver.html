<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Regras ‚Äî Sistema AURA üíú</title>

  <link rel="icon" href="../Aurinha.png" />
  <link rel="stylesheet" href="../style.css" />

  <style>
    .page-container { padding: 2rem; max-width: 1100px; margin: 0 auto; }

    .topbar {
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      margin-bottom:1.4rem;
    }

    .actions { display:flex; gap:8px; flex-wrap:wrap; }

    .btn {
      background: linear-gradient(90deg,#9b4dff,#b86bff);
      border:none;
      border-radius:10px;
      padding:8px 14px;
      color:#fff;
      font-weight:600;
      cursor:pointer;
      box-shadow:0 0 10px rgba(180,107,255,.25);
      transition:.2s;
      font-size:.9rem;
    }
    .btn:hover {
      transform:translateY(-1px);
      box-shadow:0 10px 22px rgba(180,107,255,.35);
    }
    .btn-soft {
      background:rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.1);
    }

    .searchbar {
      display:flex;
      align-items:center;
      gap:10px;
      margin: 0 0 1rem;
      padding:.7rem 1rem;
      border-radius:14px;
      background:rgba(255,255,255,.06);
      box-shadow:0 0 14px rgba(180,107,255,.25);
    }
    .searchbar span {
      font-size:1.1rem;
      opacity:.9;
    }
    .searchbar input {
      flex:1;
      border:none;
      outline:none;
      background:transparent;
      color:#fff;
      font-size:1rem;
    }

    .filter-row {
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-bottom:1rem;
    }
    .filter-chip {
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(20,0,40,.7);
      font-size:.8rem;
      cursor:pointer;
      opacity:.85;
      transition:.18s;
    }
    .filter-chip:hover {
      transform:translateY(-1px);
      box-shadow:0 8px 16px rgba(180,107,255,.25);
    }
    .filter-chip.active {
      background:linear-gradient(135deg,#b46bff,#9b4dff);
      border-color:transparent;
      opacity:1;
    }

    .counter {
      font-size:.85rem;
      opacity:.8;
      margin-bottom:.6rem;
    }

    .rules-container {
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .rule-section {
      background:rgba(255,255,255,.05);
      border-radius:16px;
      border:1px solid rgba(255,255,255,.08);
      overflow:hidden;
      box-shadow:0 10px 22px rgba(180,107,255,.15);
    }

    .section-header {
      padding:.9rem 1.1rem;
      display:flex;
      justify-content:space-between;
      align-items:center;
      cursor:pointer;
    }
    .section-header h2 {
      font-size:1rem;
      margin:0;
      display:flex;
      align-items:center;
      gap:6px;
    }
    .section-header small {
      opacity:.7;
      font-weight:400;
      font-size:.8rem;
    }
    .section-toggle {
      font-size:1.2rem;
      opacity:.8;
      transition:.18s;
    }
    .section-header:hover .section-toggle {
      transform:translateY(-1px);
    }

    .section-body {
      max-height:0;
      overflow:hidden;
      transition:max-height .25s ease;
    }
    .section-body-inner {
      padding: .4rem 1.1rem 1rem;
      display:flex;
      flex-direction:column;
      gap:.6rem;
    }

    .rule-card {
      padding:.6rem .7rem;
      border-radius:10px;
      background:rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.06);
      font-size:.9rem;
    }
    .rule-card h3 {
      margin:0 0 .25rem;
      font-size:.92rem;
    }
    .rule-card p {
      margin:0;
      line-height:1.35;
      opacity:.9;
      white-space:pre-line;
    }

    .muted { opacity:.8; font-size:.85rem; }
    .tag {
      display:inline-flex;
      align-items:center;
      gap:4px;
      padding:2px 7px;
      border-radius:999px;
      background:rgba(0,0,0,.3);
      font-size:.75rem;
      opacity:.85;
    }

    /* Toast simples p/ futuro se quiseres usar */
    .aura-toast{
      position:fixed;
      right:16px;
      bottom:16px;
      z-index:1200;
      display:flex;
      gap:10px;
      align-items:center;
      background:rgba(20,0,40,.95);
      border:1px solid rgba(255,255,255,.08);
      padding:.7rem 1rem;
      border-radius:12px;
      color:#fff;
      box-shadow:0 10px 24px rgba(180,107,255,.35);
      animation:fadeIn .15s ease;
      font-size:.85rem;
    }
    @keyframes fadeIn { from{opacity:0} to{opacity:1} }
  </style>
</head>

<body>
  <!-- SIDEBAR -->
  <div class="sidebar">
    <h2 class="logo">SISTEMA AURA</h2>
    <span id="agentNameDisplay" class="agent-display">Agente: -</span>

    <ul>
      <li><a href="../dashboard.html" class="navlink"><span class="icon">üè†</span><span class="label">Dashboard</span></a></li>
      <li><a href="../pesquisa/ver.html" class="navlink"><span class="icon">üîç</span><span class="label">Pesquisa Geral</span></a></li>
      <li><a href="../perfis/ver.html" class="navlink"><span class="icon">üëë</span><span class="label">Perfil da Aura</span></a></li>
      <li><a href="../people/ver.html" class="navlink"><span class="icon">üßç</span><span class="label">Pessoas</span></a></li>
      <li><a href="../casos/ver.html" class="navlink"><span class="icon">üìÅ</span><span class="label">Casos</span></a></li>
      <li><a href="../investigacoes/ver.html" class="navlink"><span class="icon">üïµÔ∏è</span><span class="label">Investiga√ß√µes</span></a></li>
      <li><a href="../veiculos/ver.html" class="navlink"><span class="icon">üèéÔ∏è</span><span class="label">Ve√≠culos</span></a></li>
      <li><a href="../facc/ver.html" class="navlink"><span class="icon">‚öîÔ∏è</span><span class="label">Fac√ß√µes</span></a></li>
      <li><a href="../perimetro/ver.html" class="navlink"><span class="icon">üìç</span><span class="label">Per√≠metro de A√ß√µes</span></a></li>
      <li><a href="../reunioes/ver.html" class="navlink"><span class="icon">üóìÔ∏è</span><span class="label">Reuni√µes</span></a></li>
      <li><a href="../regras/ver.html" class="navlink active"><span class="icon">üìö</span><span class="label">Regras Cidade</span></a></li>
    </ul>

    <button id="logoutBtn">Sair</button>
  </div>

  <!-- CONTE√öDO -->
  <div class="main-content">
    <div class="page-container">
      <div class="topbar">
        <h1>Regras ‚Äî Cidade dos Anjos</h1>
        <div class="actions">
          <button class="btn btn-soft" id="backBtn">‚¨Ö Voltar ao Dashboard</button>
          <button class="btn btn-soft" id="openDocBtn">üìÑ Abrir Documento Original</button>
        </div>
      </div>

      <div class="searchbar">
        <span>üîé</span>
        <input id="searchInput" placeholder="Pesquisar por palavra-chave (ex: safezone, sequestro, joalheria...)" />
      </div>

      <div class="filter-row" id="filterRow">
        <!-- preenchido via JS -->
      </div>

      <div class="counter" id="counter"></div>

      <div class="rules-container" id="rulesContainer">
        <!-- conte√∫do das regras vem de data.js -->
      </div>

    </div>
  </div>

  <!-- L√ìGICA (usa ficheiro externo de dados) -->
  <script type="module">
    import { REGRAS_CATEGORIAS } from "./data.js";

    const searchInput   = document.getElementById("searchInput");
    const filterRow     = document.getElementById("filterRow");
    const rulesContainer= document.getElementById("rulesContainer");
    const counter       = document.getElementById("counter");

    const backBtn       = document.getElementById("backBtn");
    const openDocBtn    = document.getElementById("openDocBtn");

    backBtn.onclick = () => window.location.href = "../dashboard.html";
    openDocBtn.onclick = () => {
      // link do Google Docs com as regras oficiais
      window.open("https://docs.google.com/document/d/106zptZpOR-hvGcg0t4AAVx3E4fVGy8M6k0j2GBuJBY8/edit", "_blank");
    };

    // PERFIL + LOGOUT
    (function(){
      const agent = localStorage.getItem("selectedAgent") || "Desconhecido";
      const el = document.getElementById("agentNameDisplay");
      if (el) el.textContent = `Agente: ${agent}`;

      const logoutBtn = document.getElementById("logoutBtn");
      if (logoutBtn) {
        logoutBtn.addEventListener("click", () => {
          ["username","selectedAgent","userRole","userCode","isAdmin"].forEach(k => localStorage.removeItem(k));
          window.location.href = "../select.html";
        });
      }
    })();

    // Criar filtros (chips)
    let activeCategory = "all";

    function buildFilters() {
      const allChip = document.createElement("button");
      allChip.className = "filter-chip active";
      allChip.dataset.filter = "all";
      allChip.textContent = "Todos";
      filterRow.appendChild(allChip);

      allChip.addEventListener("click", () => {
        setActiveFilter("all");
      });

      REGRAS_CATEGORIAS.forEach(cat => {
        const chip = document.createElement("button");
        chip.className = "filter-chip";
        chip.dataset.filter = cat.id;
        chip.textContent = cat.label;
        filterRow.appendChild(chip);

        chip.addEventListener("click", () => {
          setActiveFilter(cat.id);
        });
      });
    }

    function setActiveFilter(id) {
      activeCategory = id;
      document.querySelectorAll(".filter-chip").forEach(ch => {
        ch.classList.toggle("active", ch.dataset.filter === id);
      });
      applyFilters();
    }

    // Render inicial das sec√ß√µes
    function buildSections() {
      rulesContainer.innerHTML = "";

      REGRAS_CATEGORIAS.forEach(cat => {
        const sec = document.createElement("section");
        sec.className = "rule-section";
        sec.dataset.categoryId = cat.id;

        const header = document.createElement("div");
        header.className = "section-header";
        header.innerHTML = `
          <h2>${cat.emoji || "üìÇ"} ${cat.label}</h2>
          <div class="section-toggle">Ôºã</div>
        `;

        const body = document.createElement("div");
        body.className = "section-body";

        const inner = document.createElement("div");
        inner.className = "section-body-inner";

        // cards de regras
        cat.items.forEach((rule, idx) => {
          const card = document.createElement("div");
          card.className = "rule-card";

          const textSearch = [
            cat.label,
            rule.code || "",
            rule.title || "",
            rule.body || ""
          ].join(" ").toLowerCase();

          card.dataset.search = textSearch;

          card.innerHTML = `
            <h3>${rule.code ? rule.code + " ‚Äî " : ""}${rule.title || "Regra"}</h3>
            <p>${rule.body || ""}</p>
          `;

          inner.appendChild(card);
        });

        body.appendChild(inner);
        sec.appendChild(header);
        sec.appendChild(body);
        rulesContainer.appendChild(sec);

        // abre/fecha sec√ß√£o
        header.addEventListener("click", () => {
          const isOpen = body.style.maxHeight && body.style.maxHeight !== "0px";
          if (isOpen) {
            body.style.maxHeight = "0px";
            header.querySelector(".section-toggle").textContent = "Ôºã";
          } else {
            body.style.maxHeight = body.scrollHeight + "px";
            header.querySelector(".section-toggle").textContent = "Ôºç";
          }
        });

        // por padr√£o: abre primeiras duas sec√ß√µes
        // (se quiser tudo fechado, s√≥ apagar este bloco)
        setTimeout(() => {
          if (["geral","discord"].includes(cat.id)) {
            body.style.maxHeight = body.scrollHeight + "px";
            header.querySelector(".section-toggle").textContent = "Ôºç";
          }
        }, 0);
      });

      applyFilters(); // aplica filtro + conta
    }

    function applyFilters() {
      const term = (searchInput.value || "").toLowerCase().trim();
      let visibleCards = 0;

      document.querySelectorAll(".rule-section").forEach(sec => {
        const catId = sec.dataset.categoryId;
        const isCategoryVisible = (activeCategory === "all" || activeCategory === catId);

        let sectionHasVisible = false;

        // cada card
        sec.querySelectorAll(".rule-card").forEach(card => {
          const matchesCategory = isCategoryVisible;
          const matchesSearch = !term || card.dataset.search.includes(term);

          const show = matchesCategory && matchesSearch;
          card.style.display = show ? "block" : "none";
          if (show) {
            sectionHasVisible = true;
            visibleCards++;
          }
        });

        sec.style.display = sectionHasVisible ? "block" : "none";

        // Ajusta altura se estava aberto
        const body = sec.querySelector(".section-body");
        if (sectionHasVisible && body.style.maxHeight && body.style.maxHeight !== "0px") {
          body.style.maxHeight = body.scrollHeight + "px";
        }
      });

      if (!term && activeCategory === "all") {
        counter.textContent = "";
      } else {
        counter.textContent = visibleCards
          ? `Mostrando ${visibleCards} regras para o filtro/pesquisa atual.`
          : "Nenhuma regra encontrada para este filtro/pesquisa.";
      }
    }

    searchInput.addEventListener("input", () => {
      applyFilters();
    });

    // iniciar
    buildFilters();
    buildSections();
  </script>
</body>
</html>
