<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Investiga√ß√µes - Sistema AURA</title>
  <link rel="icon" href="../../Aurinha.png" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;500;700&display=swap" rel="stylesheet" />

  <style>
    body {
      background: radial-gradient(circle at top left,#1a001f,#000);
      font-family: 'Poppins', sans-serif;
      color:#fff;
      margin:0;
      padding:30px;
    }

    .top-bar {
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:20px;
    }

    .left-buttons, .right-buttons {
      display:flex;
      align-items:center;
      gap:10px;
    }

    .top-bar h2 {
      color:#d6b2ff;
      text-shadow:0 0 10px rgba(180,0,255,0.7);
      margin:0;
      text-align:center;
      flex:1;
    }

    .top-bar button {
      background: linear-gradient(90deg,#9b4dff,#b86bff);
      border:none;
      border-radius:10px;
      color:#fff;
      font-weight:600;
      padding:8px 16px;
      cursor:pointer;
      transition:0.3s;
      box-shadow:0 0 10px rgba(180,0,255,0.4);
    }

    .top-bar button:hover {
      transform:scale(1.05);
      background:linear-gradient(90deg,#b86bff,#d6aaff);
      box-shadow:0 0 15px rgba(180,0,255,0.6);
    }

    #searchBar {
      display:block;
      margin:0 auto 30px;
      width:300px;
      padding:10px;
      border:none;
      border-radius:10px;
      background:rgba(255,255,255,0.1);
      color:#fff;
      text-align:center;
    }

    #searchBar:focus {
      outline:none;
      box-shadow:0 0 10px rgba(180,0,255,0.6);
      background:rgba(255,255,255,0.15);
    }

    .grid {
      display:grid;
      grid-template-columns:repeat(auto-fill,minmax(250px,1fr));
      gap:20px;
    }

    .card {
      background:rgba(50,0,80,0.45);
      border:1px solid rgba(200,150,255,0.3);
      border-radius:20px;
      padding:15px;
      box-shadow:0 0 20px rgba(180,0,255,0.3);
      transition:all .3s ease;
      overflow:hidden;
      position:relative;
    }

    .card.expanded {
      grid-column:span 2;
      box-shadow:0 0 30px rgba(200,150,255,0.7);
      background:rgba(70,0,110,0.7);
    }

    .card h3 {
      margin:0 0 5px;
      color:#d6b2ff;
      font-weight:600;
    }

    .status {
      font-weight:600;
      padding:4px 10px;
      border-radius:8px;
      display:inline-block;
      margin:5px 0;
    }
    .status.ativa { background:rgba(0,255,0,0.2); color:#8aff8a; border:1px solid rgba(0,255,0,0.5); }
    .status.concluida { background:rgba(255,255,0,0.2); color:#fff68f; border:1px solid rgba(255,255,0,0.5); }
    .status.arquivada { background:rgba(150,100,255,0.2); color:#d6b2ff; border:1px solid rgba(180,0,255,0.5); }

    .card p { font-size:0.85rem; line-height:1.3; margin:3px 0; }
    .card .desc { color:#ccc; margin:5px 0; }

    .buttons {
      margin-top:10px;
      display:flex;
      flex-wrap:wrap;
      gap:6px;
    }

    .buttons button {
      background:linear-gradient(90deg,#9b4dff,#b86bff);
      border:none;
      border-radius:8px;
      color:#fff;
      padding:5px 10px;
      cursor:pointer;
      transition:.3s;
      flex:1;
      min-width:100px;
    }

    .buttons button:hover {
      transform:scale(1.05);
      background:linear-gradient(90deg,#b86bff,#d6aaff);
    }

    .fullDesc {
      margin-top:10px;
      color:#eee;
      font-size:0.9rem;
      text-align:left;
      animation:fadeIn .3s ease;
    }

    @keyframes fadeIn{from{opacity:0;transform:translateY(-5px);}to{opacity:1;transform:translateY(0);}}

    /* Popup neon */
    .neon-popup {
      position: fixed;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%);
      background: linear-gradient(90deg, #9b4dff, #b86bff);
      padding: 12px 25px;
      border-radius: 15px;
      color: #fff;
      font-weight: 500;
      box-shadow: 0 0 20px rgba(180,0,255,0.6);
      text-align: center;
      z-index: 9999;
      animation: fadeInUp 0.3s ease;
    }

    @keyframes fadeInUp {
      from {opacity:0; transform: translate(-50%, 10px);}
      to {opacity:1; transform: translate(-50%, 0);}
    }

    /* Modal de confirma√ß√£o */
    .confirm-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      animation: fadeIn .3s ease;
    }

    .confirm-box {
      background: rgba(40,0,60,0.95);
      border: 1px solid rgba(200,150,255,0.4);
      border-radius: 15px;
      padding: 25px;
      text-align: center;
      box-shadow: 0 0 25px rgba(180,0,255,0.7);
      width: 300px;
      animation: fadeInUp .3s ease;
    }

    .confirm-box h3 { color:#d6b2ff; margin-bottom:15px; }

    .confirm-buttons {
      display:flex;
      justify-content:space-around;
      margin-top:20px;
    }

    .confirm-buttons button {
      background: linear-gradient(90deg,#9b4dff,#b86bff);
      border: none;
      border-radius: 8px;
      color: #fff;
      padding: 8px 20px;
      cursor: pointer;
      transition: .3s;
    }

    .confirm-buttons button:hover {
      transform: scale(1.05);
      background: linear-gradient(90deg,#b86bff,#d6aaff);
    }

    .confirm-buttons .cancel {
      background: linear-gradient(90deg,#444,#666);
    }
  </style>
</head>

<body>
  <div class="top-bar">
    <div class="left-buttons">
      <button id="backBtn">‚¨Ö Voltar</button>
    </div>
    <h2>Investiga√ß√µes</h2>
    <div class="right-buttons">
      <button id="archivedBtn">üìÇ Arquivadas</button>
      <button id="newBtn">+ Criar Nova</button>
    </div>
  </div>

  <input type="text" id="searchBar" placeholder="üîç Pesquisar por c√≥digo ou t√≠tulo..." />
  <div class="grid" id="investGrid"></div>

  <script type="module">
    import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import { getFirestore, collection, getDocs, addDoc, deleteDoc, doc } 
      from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";
    import { firebaseConfig } from "../../firebaseConfig.js";

    const app = getApps().length === 0 ? initializeApp(firebaseConfig) : getApps()[0];
    const db = getFirestore(app);

    const grid = document.getElementById("investGrid");
    const search = document.getElementById("searchBar");
    let allInvestigations = [];

    // Navega√ß√£o
    document.getElementById("backBtn").addEventListener("click",()=>window.location.href="../../dashboard.html");
    document.getElementById("newBtn").addEventListener("click",()=>window.location.href="criar.html");
    document.getElementById("archivedBtn").addEventListener("click",()=>window.location.href="investigacoes_arquivadas.html");

    // Popup Neon
    function showPopup(msg){
      const popup=document.createElement("div");
      popup.className="neon-popup";
      popup.textContent=msg;
      document.body.appendChild(popup);
      setTimeout(()=>popup.remove(),3000);
    }

    // Modal de Confirma√ß√£o
    function showConfirmModal(message,onConfirm){
      const overlay=document.createElement("div");
      overlay.className="confirm-overlay";
      overlay.innerHTML=`
        <div class="confirm-box">
          <h3>${message}</h3>
          <div class="confirm-buttons">
            <button class="confirm">Confirmar</button>
            <button class="cancel">Cancelar</button>
          </div>
        </div>`;
      document.body.appendChild(overlay);
      overlay.querySelector(".confirm").addEventListener("click",()=>{overlay.remove();onConfirm();});
      overlay.querySelector(".cancel").addEventListener("click",()=>overlay.remove());
    }

    // Carregar investiga√ß√µes
    async function loadInvestigations(){
      try {
        const snap = await getDocs(collection(db, "investigacoes"));
        allInvestigations = snap.docs
          .map(d => ({ id: d.id, ...d.data() }))
          .filter(inv => inv.title || inv.code || inv.agent);
        renderInvestigations(allInvestigations);
      } catch (e) {
        console.error("Erro ao carregar:", e);
        showPopup("‚ùå Erro ao carregar dados do Firebase!");
      }
    }

    // Renderizar cards
    function renderInvestigations(list){
      grid.innerHTML="";
      if(!list.length){
        grid.innerHTML="<p style='text-align:center;opacity:0.7'>Nenhuma investiga√ß√£o encontrada.</p>";
        return;
      }

      list.forEach(inv=>{
        const shortDesc=inv.description?.length>100?inv.description.substring(0,100)+"...":inv.description||"Sem descri√ß√£o";
        const card=document.createElement("div");
        card.className="card";
        const statusClass=inv.status?.toLowerCase()||"";
        card.innerHTML=`
          <h3>${inv.code||"INV-??"} ‚Äî ${inv.title||"Sem t√≠tulo"}</h3>
          <span class="status ${statusClass}">${inv.status||"Sem status"}</span>
          <p><b>Agente:</b> ${inv.agent||"‚Äî"}</p>
          <p><b>Data In√≠cio:</b> ${inv.startDate||"‚Äî"} <b>Fim:</b> ${inv.endDate||"‚Äî"}</p>
          <p class="desc">${shortDesc}</p>
          <div class="buttons">
            <button class="viewBtn">üëÅ Ver Detalhes</button>
            <button class="editBtn">üñä Editar</button>
            <button class="archiveBtn">üì¶ Arquivar</button>
            <button class="deleteBtn">üóë Eliminar</button>
          </div>
        `;

        // Bot√µes
        const viewBtn=card.querySelector(".viewBtn");
        const editBtn=card.querySelector(".editBtn");
        const archiveBtn=card.querySelector(".archiveBtn");
        const deleteBtn=card.querySelector(".deleteBtn");

        viewBtn.addEventListener("click",()=>{
          if(card.classList.contains("expanded")){
            card.classList.remove("expanded");
            card.querySelector(".fullDesc")?.remove();
            viewBtn.textContent="üëÅ Ver Detalhes";
          } else {
            card.classList.add("expanded");
            const full=document.createElement("div");
            full.className="fullDesc";
            full.innerHTML=`<p><b>Descri√ß√£o Completa:</b><br>${inv.description||"Sem descri√ß√£o detalhada."}</p>
                            <button class="closeBtn">‚¨Ö Fechar</button>`;
            card.appendChild(full);
            full.querySelector(".closeBtn").addEventListener("click",()=>{
              card.classList.remove("expanded");
              full.remove();
              viewBtn.textContent="üëÅ Ver Detalhes";
            });
            viewBtn.textContent="‚¨Ö Fechar";
          }
        });

        editBtn.addEventListener("click",()=>window.location.href=`editar.html?id=${inv.id}`);

        archiveBtn.addEventListener("click",()=>{
          showConfirmModal("üì¶ Desejas arquivar esta investiga√ß√£o?",async()=>{
            try{
              await addDoc(collection(db,"investigacoes_arquivadas"),{...inv, archivedAt:new Date()});
              await deleteDoc(doc(db,"investigacoes",inv.id));
              showPopup("‚úÖ Investiga√ß√£o arquivada com sucesso!");
              card.remove();
            }catch(e){showPopup("‚ùå Erro ao arquivar!");}
          });
        });

        deleteBtn.addEventListener("click",()=>{
          showConfirmModal("üóë Tens certeza que queres eliminar?",async()=>{
            try{
              await deleteDoc(doc(db,"investigacoes",inv.id));
              showPopup("üóë Investiga√ß√£o eliminada!");
              card.remove();
            }catch(e){showPopup("‚ùå Erro ao eliminar!");}
          });
        });

        grid.appendChild(card);
      });
    }

    // Pesquisa din√¢mica
    search.addEventListener("input",()=>{
      const t=search.value.toLowerCase();
      const filtered=allInvestigations.filter(i=>
        (i.code||"").toLowerCase().includes(t)||
        (i.title||"").toLowerCase().includes(t)
      );
      renderInvestigations(filtered);
    });

    loadInvestigations();
  </script>
</body>
</html>
