<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Investiga√ß√µes Arquivadas ‚Äî Sistema AURA üíú</title>
  <link rel="icon" href="../Aurinha.png"/>
  <link rel="stylesheet" href="../style.css"/>

  <style>
    .page-container { padding: 2rem; }
    .topbar { display:flex; justify-content:space-between; align-items:center; margin-bottom:1.4rem; flex-wrap:wrap; gap:8px; }
    .actions { display:flex; gap:8px; flex-wrap:wrap; }
    .searchbar { margin:.5rem 0 1rem; display:flex; gap:8px; }
    .searchbar input {
      flex:1; padding:.8rem 1rem; border-radius:12px; border:none;
      background:rgba(255,255,255,.08); color:#fff; outline:none;
      box-shadow:0 0 10px rgba(180,107,255,.25);
    }

    .btn {
      background: linear-gradient(90deg,#9b4dff,#b86bff);
      border:none; border-radius:10px; color:#fff; font-weight:600;
      padding:8px 14px; cursor:pointer; transition:.2s;
      box-shadow:0 0 10px rgba(180,107,255,.25);
    }
    .btn-soft { background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.08); }
    .btn-danger { background: linear-gradient(90deg,#ff4d6d,#ff7c6b); }
    .btn:hover { transform:translateY(-1px); box-shadow:0 10px 22px rgba(180,107,255,.35); }

    .grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(300px,1fr)); gap:16px; }
    .card {
      background: rgba(255,255,255,.04);
      border: 1px solid rgba(187,147,255,.35);
      border-radius:16px;
      padding:14px;
      box-shadow:0 8px 18px rgba(180,107,255,.15);
      transition:.2s;
      opacity:.85;
    }
    .card:hover { transform:translateY(-3px); opacity:1; }
    .thumb {
      width:80px; height:80px; border-radius:10px; object-fit:cover;
      display:block; margin:2px auto 10px;
      box-shadow:0 0 12px rgba(180,107,255,.35);
      background:#1d0a33;
    }
    .thumb-file {
      width:80px; height:80px; border-radius:10px; display:flex; align-items:center; justify-content:center;
      margin:2px auto 10px; background:rgba(255,255,255,.08); font-weight:700;
      box-shadow:0 0 12px rgba(180,107,255,.35);
    }
    .card h3 { margin:.35rem 0 .2rem; text-align:center; }
    .meta { font-size:.95rem; color:#ddd; margin:2px 0; text-align:center; }
    .meta b{ color:#fff; }
    .buttons { display:flex; gap:8px; margin-top:.8rem; flex-wrap:wrap; justify-content:center; }

    /* toast/modal igual ao resto */
    .aura-toast{position:fixed;right:16px;bottom:16px;z-index:1200;display:flex;gap:10px;align-items:center;background:rgba(20,0,40,.95);border:1px solid rgba(255,255,255,.08);padding:.7rem 1rem;border-radius:12px;color:#fff;box-shadow:0 10px 24px rgba(180,107,255,.35);animation:fadeIn .15s ease;}
    .aura-toast.success{border-color:rgba(140,255,199,.35);}
    .aura-toast.error{border-color:rgba(255,124,107,.35);}
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}
    .aura-modal-wrap{position:fixed;inset:0;background:rgba(0,0,0,.55);display:flex;align-items:center;justify-content:center;padding:20px;z-index:1400;animation:fadeIn .15s ease;}
    .aura-modal{width:min(560px,95vw);background:rgba(20,0,40,.92);border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:18px;color:#fff;box-shadow:0 18px 40px rgba(180,107,255,.35);}
    .aura-modal .row{display:flex;gap:10px;justify-content:flex-end;}
    .aura-btn{background:rgba(255,255,255,.08);color:#fff;border:1px solid rgba(255,255,255,.08);padding:.6rem .9rem;border-radius:10px;cursor:pointer;font-weight:600;}
    .aura-btn.primary{background: linear-gradient(135deg,#b46bff,#9f4dff);}
    .aura-btn.danger{background: linear-gradient(135deg,#ff4d6d,#ff7c6b);}
  </style>
</head>
<body>
  <div class="sidebar">
    <h2 class="logo">SISTEMA AURA</h2>
    <ul>
      <li><a href="../dashboard.html" class="navlink"><span class="icon">üè†</span> Dashboard</a></li>
      <li><a href="ver.html" class="navlink"><span class="icon">üïµÔ∏è‚Äç‚ôÄÔ∏è</span> Investiga√ß√µes</a></li>
      <li><a href="arquivadas.html" class="navlink active"><span class="icon">üóÉÔ∏è</span> Arquivadas</a></li>
    </ul>
    <button id="logoutBtn">Sair</button>
  </div>

  <div class="main-content">
    <div class="page-container">
      <div class="topbar">
        <h1>Investiga√ß√µes Arquivadas</h1>
        <div class="actions">
          <button id="backBtn" class="btn btn-soft">‚¨ÖÔ∏è Voltar</button>
        </div>
      </div>
      <div class="searchbar">
        <input id="searchBar" placeholder="Pesquisar investiga√ß√µes arquivadas..." />
      </div>
      <div id="invGrid" class="grid"></div>
    </div>
  </div>

  <script type="module">
    import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import {
      getFirestore, collection, getDocs, deleteDoc, doc, updateDoc, query, where
    } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";
    import { firebaseConfig } from "../firebaseConfig.js";

    const app = getApps().length ? getApps()[0] : initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const grid = document.getElementById("invGrid");
    const search = document.getElementById("searchBar");

    const isAdmin = localStorage.getItem("isAdmin")==="true";
    const roleStr = (localStorage.getItem("userRole")||"").toLowerCase();
    const canEdit = isAdmin || roleStr==="investigador";

    document.getElementById("backBtn").onclick = ()=> window.location.href="ver.html";

    function toast(msg,type="success"){
      const t=document.createElement("div");
      t.className=`aura-toast ${type}`;
      t.innerHTML=`<span>${type==="success"?"‚úÖ":"‚ö†Ô∏è"}</span><span>${msg}</span>`;
      document.body.appendChild(t);
      setTimeout(()=>{t.style.opacity="0";setTimeout(()=>t.remove(),250);},1800);
    }

    function confirmModal({title="Confirmar",message="Tens a certeza?",okText="Confirmar",variant="primary"}){
      return new Promise(resolve=>{
        const wrap=document.createElement("div");
        wrap.className="aura-modal-wrap";
        wrap.innerHTML=`
          <div class="aura-modal">
            <h3>${title}</h3>
            <p>${message}</p>
            <div class="row">
              <button class="aura-btn">Cancelar</button>
              <button class="aura-btn ${variant==='danger'?'danger':'primary'}">${okText}</button>
            </div>
          </div>`;
        document.body.appendChild(wrap);
        const [cancel,ok]=wrap.querySelectorAll("button");
        cancel.onclick=()=>{wrap.remove();resolve(false)};
        ok.onclick=()=>{wrap.remove();resolve(true)};
        wrap.addEventListener("click",(e)=>{if(e.target===wrap){wrap.remove();resolve(false)}})
      });
    }

    function isImageLike(url,type){
      if(type && type.startsWith("image/")) return true;
      return /\.(png|jpe?g|gif|webp|bmp|svg)$/i.test(url||"");
    }

    let allItems=[];
    async function loadAll(){
      try{
        const q=query(collection(db,"investigacoes"),where("estado","==","arquivado"));
        const snap=await getDocs(q);
        allItems=snap.docs.map(d=>({id:d.id,...d.data()}));
      }catch(e){
        console.warn("Sem √≠ndice, usando fallback:",e);
        const snap=await getDocs(collection(db,"investigacoes"));
        allItems=snap.docs.map(d=>({id:d.id,...d.data()})).filter(x=>(x.estado||"")=="arquivado");
      }
      render(allItems);
    }

    function render(list){
      grid.innerHTML="";
      if(!list.length){grid.innerHTML="<p class='muted'>Nenhuma investiga√ß√£o arquivada.</p>";return;}
      list.forEach(inv=>{
        const isImg=isImageLike(inv.photoURL,inv.fileType);
        const thumb=inv.photoURL?(isImg?`<img class="thumb" src="${inv.photoURL}">`:`<div class="thumb-file">üìÑ</div>`):"";
        const el=document.createElement("div");
        el.className="card";
        el.innerHTML=`
          ${thumb}
          <h3>${inv.titulo||"Sem t√≠tulo"}</h3>
          <div class="meta"><b>Respons√°vel:</b> ${inv.responsavel||"-"}</div>
          <div class="buttons">
            <button class="btn btn-soft viewBtn">üëÅ Ver</button>
            ${canEdit?`
              <button class="btn btn-soft reopenBtn">üóÉ Reabrir</button>
              <button class="btn btn-danger delBtn">üóë Eliminar</button>`:""}
          </div>`;
        el.querySelector(".viewBtn").onclick=()=>{
          const wrap=document.createElement("div");
          wrap.className="aura-modal-wrap";
          wrap.innerHTML=`
            <div class="aura-modal">
              <h3>${inv.titulo||"Sem t√≠tulo"}</h3>
              <p><b>Respons√°vel:</b> ${inv.responsavel||"-"}</p>
              <p><b>Descri√ß√£o:</b><br>${inv.descricao||"Sem descri√ß√£o."}</p>
              <div class="row"><button class="aura-btn primary">Fechar</button></div>
            </div>`;
          wrap.querySelector("button").onclick=()=>wrap.remove();
          wrap.addEventListener("click",(e)=>{if(e.target===wrap)wrap.remove();});
          document.body.appendChild(wrap);
        };
        el.querySelector(".reopenBtn")?.addEventListener("click",async()=>{
          const ok=await confirmModal({title:"Reabrir investiga√ß√£o",message:`Reabrir <b>${inv.titulo||inv.id}</b>?`,okText:"Reabrir"});
          if(!ok)return;
          try{
            await updateDoc(doc(db,"investigacoes",inv.id),{estado:"ativo"});
            el.remove();
            toast("Investiga√ß√£o reaberta!");
            setTimeout(()=>window.location.href="ver.html",600);
          }catch(e){console.error(e);toast("Erro ao reabrir","error");}
        });
        el.querySelector(".delBtn")?.addEventListener("click",async()=>{
          const ok=await confirmModal({title:"Eliminar investiga√ß√£o",message:`Eliminar <b>${inv.titulo||inv.id}</b>?`,okText:"Eliminar",variant:"danger"});
          if(!ok)return;
          try{
            await deleteDoc(doc(db,"investigacoes",inv.id));
            el.remove();
            toast("Investiga√ß√£o eliminada!");
          }catch(e){console.error(e);toast("Erro ao eliminar","error");}
        });
        grid.appendChild(el);
      });
    }

    search.addEventListener("input",(e)=>{
      const t=(e.target.value||"").toLowerCase().trim();
      const f=allItems.filter(i=>(i.titulo||"").toLowerCase().includes(t)||(i.responsavel||"").toLowerCase().includes(t));
      render(f);
    });

    loadAll();
  </script>

  <script>
    document.getElementById("logoutBtn").onclick=()=>{
      ["username","selectedAgent","userRole","userCode","isAdmin"].forEach(k=>localStorage.removeItem(k));
      window.location.href="../select.html";
    }
  </script>
</body>
</html>
