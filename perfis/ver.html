<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Perfil da Aura â€” Sistema AURA ğŸ’œ</title>

  <link rel="icon" href="../Aurinha.png" />
  <link rel="stylesheet" href="../style.css" />

  <style>
    .page-container { padding: 2rem; }

    .topbar {
      display:flex; justify-content:space-between; align-items:center;
      gap:10px; flex-wrap:wrap; margin-bottom:1.2rem;
    }

    .btn {
      background: linear-gradient(90deg,#9b4dff,#b86bff);
      border:none; border-radius:10px;
      padding:8px 14px; color:#fff; font-weight:600;
      cursor:pointer; box-shadow:0 0 10px rgba(180,107,255,.25);
      transition:.2s;
    }

    .btn:hover { transform:translateY(-1px); box-shadow:0 10px 22px rgba(180,107,255,.35); }

    .btn-soft {
      background: rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.08);
    }

    .searchbar { margin:.5rem 0 1rem; display:flex; gap:8px; }
    .searchbar input {
      flex:1; padding:.8rem 1rem;
      background:rgba(255,255,255,.08);
      border:none; border-radius:12px; color:#fff; outline:none;
    }

    .grid {
      display:grid; grid-template-columns:repeat(auto-fill,minmax(250px,1fr));
      gap:16px;
    }

    .card {
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.06);
      border-radius:14px;
      padding:1rem; text-align:center;
      box-shadow:0 10px 22px rgba(180,107,255,.15);
    }

    .card img {
      width:84px; height:84px; border-radius:50%;
      object-fit:cover; box-shadow:0 0 12px rgba(180,107,255,.35);
    }

    .buttons { display:flex; justify-content:center; gap:8px; margin-top:.6rem; flex-wrap:wrap; }

    /* Modal */
    .aura-modal-wrap {
      position:fixed; inset:0; background:rgba(0,0,0,.55);
      display:flex; justify-content:center; align-items:center;
      z-index:2000; animation:fadeIn .15s ease;
    }

    .aura-modal {
      background:rgba(20,0,40,.92); color:#fff;
      border:1px solid rgba(255,255,255,.08);
      padding:20px; border-radius:16px;
      width:min(480px,90vw); text-align:center;
      animation:popIn .2s ease forwards;
    }

    @keyframes fadeIn { from{opacity:0} to{opacity:1} }
    @keyframes popIn { from{transform:translateY(20px)} to{transform:translateY(0)} }

    .aura-btn {
      padding:.7rem 1.1rem; border-radius:10px; font-weight:600;
      cursor:pointer; border:none;
    }
    .aura-btn.primary { background:linear-gradient(135deg,#b46bff,#9f4dff); color:#fff; }

    .muted { opacity:.7; }
  </style>
</head>

<body>

  <!-- MENU LATERAL -->
  <div class="sidebar">
    <h2 class="logo">SISTEMA AURA</h2>
    <span id="agentNameDisplay" class="agent-display">Agente: -</span>

    <ul>
      <li><a href="../dashboard.html" class="navlink"><span class="icon">ğŸ </span>Dashboard</a></li>
      <li><a href="../pesquisa/ver.html" class="navlink"><span class="icon">ğŸ”</span>Pesquisa Geral</a></li>
      <li><a href="../perfis/ver.html" class="navlink active"><span class="icon">ğŸ‘‘</span>Perfil da Aura</a></li>
      <li><a href="../people/ver.html" class="navlink"><span class="icon">ğŸ§</span>Pessoas</a></li>
      <li><a href="../casos/ver.html" class="navlink"><span class="icon">ğŸ“</span>Casos</a></li>
      <li><a href="../investigacoes/ver.html" class="navlink"><span class="icon">ğŸ•µï¸</span>InvestigaÃ§Ãµes</a></li>
      <li><a href="../veiculos/ver.html" class="navlink"><span class="icon">ğŸï¸</span>VeÃ­culos</a></li>
      <li><a href="../facc/ver.html" class="navlink"><span class="icon">âš”ï¸</span>FacÃ§Ãµes</a></li>
      <li><a href="../perimetro/ver.html" class="navlink"><span class="icon">ğŸ“</span>PerÃ­metro</a></li>
      <li><a href="../reunioes/ver.html" class="navlink"><span class="icon">ğŸ—“ï¸</span>ReuniÃµes</a></li>
    </ul>

    <button id="logoutBtn">Sair</button>
  </div>

  <!-- CONTEÃšDO -->
  <div class="main-content">
    <div class="page-container">

      <div class="topbar">
        <h1>Perfil da Aura</h1>
        <div>
          <button id="newBtn" class="btn only-editor">â• Novo Perfil</button>
        </div>
      </div>

      <div class="searchbar">
        <input id="searchBar" placeholder="Pesquisar por nome ou divisÃ£o..." />
      </div>

      <div id="profilesGrid" class="grid"></div>

    </div>
  </div>

  <!-- FIREBASE SCRIPT -->
  <script type="module">
    import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import {
      getFirestore, collection, getDocs, deleteDoc,
      updateDoc, addDoc, doc, serverTimestamp,
      query, orderBy
    } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

    import { firebaseConfig } from "../firebaseConfig.js";

    const app = getApps().length ? getApps()[0] : initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const grid = document.getElementById("profilesGrid");
    const search = document.getElementById("searchBar");

    const isAdmin = localStorage.getItem("isAdmin") === "true";
    const role = (localStorage.getItem("userRole") || "").toLowerCase();
    const canEdit = isAdmin || role === "investigador";

    let allProfiles = [];

    // NavegaÃ§Ã£o
    document.getElementById("newBtn").onclick = () => window.location.href = "criar.html";

    // LOAD
    async function loadProfiles() {

      const q = query(
        collection(db,"users"),
        orderBy("createdAt", "asc")    // MAIS NOVOS EM CIMA
      );

      const snap = await getDocs(q);

      allProfiles = snap.docs.map(d => ({
        id: d.id,
        ...d.data()
      }));

      render(allProfiles);
    }

    // RenderizaÃ§Ã£o
    function render(list){
      grid.innerHTML = "";

      if(!list.length){
        grid.innerHTML = "<p class='muted'>Nenhum perfil encontrado.</p>";
        return;
      }

      list.forEach(p => {

        const card = document.createElement("div");
        card.className = "card";

        card.innerHTML = `
          <img src="${p.photoURL || '../Aurinha.png'}" />
          <h3>${p.name || 'Sem nome'}</h3>
          <p><b>DivisÃ£o:</b> ${p.division || '-'}</p>
          <p><b>Cargo:</b> ${p.role || '-'}</p>

          <div class="buttons">
            <button class="btn btn-soft viewBtn">ğŸ‘ Ver</button>

            ${canEdit ? `
              <button class="btn btn-soft editBtn">ğŸ–Š Editar</button>
              <button class="btn btn-soft archiveBtn">ğŸ“¦ Arquivar</button>
            ` : ""}

            ${isAdmin ? `
              <button class="btn btn-soft toggleInvBtn">${p.role==="investigador"?"Retirar Investigador":"Dar Investigador"}</button>
              <button class="btn btn-soft toggleAdminBtn">${p.isAdmin?"Retirar Admin":"Dar Admin"}</button>
              <button class="btn btn-danger deleteBtn">ğŸ—‘ Eliminar</button>
            ` : ""}
          </div>
        `;

        // VER
        card.querySelector(".viewBtn").onclick = () => {
          const wrap = document.createElement("div");
          wrap.className = "aura-modal-wrap";

          wrap.innerHTML = `
            <div class="aura-modal">
              <img src="${p.photoURL || '../Aurinha.png'}"
              style="width:110px;height:110px;border-radius:50%;object-fit:cover;margin-bottom:10px;" />

              <h3>${p.name}</h3>
              <p><b>DivisÃ£o:</b> ${p.division || "-"}</p>
              <p><b>Cargo:</b> ${p.role || "-"}</p>
              <p><b>Admin:</b> ${p.isAdmin ? "Sim" : "NÃ£o"}</p>
              <p><b>ID:</b> ${p.id}</p>

              <button class="aura-btn primary" id="close">Fechar</button>
            </div>
          `;

          wrap.onclick = e => { if(e.target===wrap) wrap.remove(); };
          wrap.querySelector("#close").onclick = () => wrap.remove();

          document.body.appendChild(wrap);
        };

        // EDITAR
        card.querySelector(".editBtn")?.addEventListener("click", () => {
          window.location.href = `editar.html?id=${p.id}`;
        });

        // ARCHIVE
        card.querySelector(".archiveBtn")?.addEventListener("click", async () => {
          await addDoc(collection(db, "users_archived"), { ...p, archivedAt:new Date() });
          await deleteDoc(doc(db, "users", p.id));
          card.remove();
        });

        grid.appendChild(card);
      });
    }

    // Pesquisa
    search.addEventListener("input", e => {
      const t = e.target.value.toLowerCase();
      const filtered = allProfiles.filter(p =>
        (p.name || "").toLowerCase().includes(t) ||
        (p.division || "").toLowerCase().includes(t)
      );
      render(filtered);
    });

    loadProfiles();
  </script>

  <script>
    // Perfil + Logout
    (function(){
      const agent = localStorage.getItem("selectedAgent") || "Desconhecido";
      document.getElementById("agentNameDisplay").textContent = `Agente: ${agent}`;

      document.getElementById("logoutBtn").onclick = () => {
        ["username","selectedAgent","userRole","userCode","isAdmin"].forEach(k => localStorage.removeItem(k));
        window.location.href = "../select.html";
      };
    })();
  </script>

</body>
</html>
