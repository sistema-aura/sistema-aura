<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Perfis - Sistema Aura</title>
  <link rel="icon" href="../../Aurinha.png" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;500;700&display=swap" rel="stylesheet" />

  <style>
    body {
      background: radial-gradient(circle at top left, #1a001f, #000);
      font-family: 'Poppins', sans-serif;
      color: #fff;
      margin: 0;
      padding: 30px;
    }

    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
    }

    .left-buttons, .right-buttons {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .top-bar h2 {
      color: #d6b2ff;
      text-shadow: 0 0 10px rgba(180,0,255,0.7);
      margin: 0;
      text-align: center;
      flex: 1;
    }

    button {
      background: linear-gradient(90deg,#9b4dff,#b86bff);
      border: none;
      border-radius: 10px;
      color: #fff;
      font-weight: 600;
      padding: 8px 16px;
      cursor: pointer;
      transition: 0.3s;
      box-shadow: 0 0 10px rgba(180,0,255,0.4);
    }

    button:hover {
      transform: scale(1.05);
      background: linear-gradient(90deg,#b86bff,#d6aaff);
      box-shadow: 0 0 15px rgba(180,0,255,0.6);
    }

    #searchBar {
      display:block;
      margin:0 auto 30px;
      width:300px;
      padding:10px;
      border:none;
      border-radius:10px;
      background:rgba(255,255,255,0.1);
      color:#fff;
      text-align:center;
    }

    #searchBar:focus {
      outline:none;
      box-shadow:0 0 10px rgba(180,0,255,0.6);
      background:rgba(255,255,255,0.15);
    }

    .grid {
      display:grid;
      grid-template-columns:repeat(auto-fill,minmax(250px,1fr));
      gap:20px;
    }

    .card {
      background:rgba(50,0,80,0.45);
      border:1px solid rgba(200,150,255,0.3);
      border-radius:20px;
      padding:15px;
      box-shadow:0 0 20px rgba(180,0,255,0.3);
      transition:all .3s ease;
      text-align:center;
    }

    .card img {
      width:80px;
      height:80px;
      border-radius:50%;
      object-fit:cover;
      box-shadow:0 0 10px rgba(180,0,255,0.6);
      margin-bottom:10px;
    }

    .card h3 {
      margin:0;
      color:#d6b2ff;
    }

    .card p {
      margin:5px 0;
      font-size:0.9rem;
    }

    .buttons {
      margin-top:10px;
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      justify-content:center;
    }

    .buttons button {
      flex:1;
      min-width:100px;
    }

    .popup {
      position:fixed;
      bottom:30px;
      left:50%;
      transform:translateX(-50%);
      background:linear-gradient(90deg,#9b4dff,#b86bff);
      padding:12px 25px;
      border-radius:15px;
      color:#fff;
      font-weight:500;
      box-shadow:0 0 20px rgba(180,0,255,0.6);
      animation:fadeInUp .3s ease;
      z-index:1000;
    }

    @keyframes fadeInUp {
      from {opacity:0; transform:translate(-50%,10px);}
      to {opacity:1; transform:translate(-50%,0);}
    }

    .overlay {
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.8);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:1000;
    }

    .modal {
      background:rgba(40,0,60,0.95);
      border:1px solid rgba(200,150,255,0.4);
      border-radius:15px;
      padding:25px;
      width:350px;
      text-align:center;
      box-shadow:0 0 25px rgba(180,0,255,0.7);
    }

    .modal img {
      width:100px;
      height:100px;
      border-radius:50%;
      object-fit:cover;
      margin-bottom:10px;
    }
  </style>
</head>
<body>

  <div class="top-bar">
    <div class="left-buttons">
      <button id="backBtn">‚¨Ö Voltar</button>
    </div>
    <h2>Perfis da Aura</h2>
    <div class="right-buttons">
      <button id="archivedBtn">üìÇ Arquivados</button>
      <button id="newBtn">+ Criar Novo</button>
    </div>
  </div>

  <input type="text" id="searchBar" placeholder="üîç Pesquisar por nome ou divis√£o..." />
  <div class="grid" id="profilesGrid"></div>

  <script type="module">
    import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import { getFirestore, collection, getDocs, addDoc, deleteDoc, doc, serverTimestamp } 
      from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";
    import { firebaseConfig } from "../../firebaseConfig.js";

    const app = getApps().length===0 ? initializeApp(firebaseConfig) : getApps()[0];
    const db = getFirestore(app);

    const grid = document.getElementById("profilesGrid");
    const search = document.getElementById("searchBar");
    let allProfiles = [];

    const currentAgent = localStorage.getItem("selectedAgent") || "Desconhecido";

    const popup = msg => {
      const el = document.createElement("div");
      el.className = "popup";
      el.textContent = msg;
      document.body.appendChild(el);
      setTimeout(()=>el.remove(),3000);
    };

    async function addLog(action, itemType, itemTitle){
      try{
        await addDoc(collection(db,"logs"),{
          user: currentAgent,
          action,
          itemType,
          itemTitle,
          timestamp: serverTimestamp()
        });
      }catch(e){ console.error("Erro ao registrar log:", e); }
    }

    document.getElementById("backBtn").onclick=()=>window.location.href="../../dashboard.html";
    document.getElementById("archivedBtn").onclick=()=>window.location.href="arquivados.html";
    document.getElementById("newBtn").onclick=()=>window.location.href="criar.html";

    async function loadProfiles(){
      const snap = await getDocs(collection(db,"users"));
      allProfiles = snap.docs.map(d=>({id:d.id,...d.data()}));
      render(allProfiles);
    }

    function render(list){
      grid.innerHTML="";
      if(!list.length){
        grid.innerHTML="<p style='text-align:center;opacity:0.7'>Nenhum perfil encontrado.</p>";
        return;
      }

      list.forEach(p=>{
        const card=document.createElement("div");
        card.className="card";
        card.innerHTML=`
          <img src="${p.photoURL || '../../Aurinha.png'}" alt="avatar">
          <h3>${p.name || 'Sem nome'}</h3>
          <p><b>Divis√£o:</b> ${p.division || '-'}</p>
          <p><b>Cargo:</b> ${p.role || '-'}</p>
          <div class="buttons">
            <button class="viewBtn">üëÅ Ver</button>
            <button class="editBtn">üñä Editar</button>
            <button class="archiveBtn">üì¶ Arquivar</button>
            <button class="deleteBtn">üóë Eliminar</button>
          </div>
        `;

        // Ver
        card.querySelector(".viewBtn").onclick=()=>{
          const overlay=document.createElement("div");
          overlay.className="overlay";
          overlay.innerHTML=`
            <div class="modal">
              <img src="${p.photoURL || '../../Aurinha.png'}" alt="avatar">
              <h3>${p.name || 'Sem nome'}</h3>
              <p><b>Divis√£o:</b> ${p.division || '-'}</p>
              <p><b>Cargo:</b> ${p.role || '-'}</p>
              <p><b>Entrada:</b> ${p.joinDate || '-'}</p>
              <p><b>Descri√ß√£o:</b><br>${p.description || 'Sem descri√ß√£o.'}</p>
              <button onclick="this.closest('.overlay').remove()">Fechar</button>
            </div>`;
          document.body.appendChild(overlay);
        };

        // Editar
        card.querySelector(".editBtn").onclick=()=>window.location.href=`editar.html?id=${p.id}`;

        // Arquivar
        card.querySelector(".archiveBtn").onclick=async()=>{
          if(confirm(`üì¶ Desejas arquivar o perfil ${p.name}?`)){
            try{
              await addDoc(collection(db,"users_archived"),{...p, archivedAt:new Date()});
              await deleteDoc(doc(db,"users",p.id));
              await addLog("arquivou","perfil",p.name);
              popup("‚úÖ Perfil arquivado!");
              card.remove();
            }catch(e){ popup("‚ùå Erro ao arquivar!"); }
          }
        };

        // Eliminar
        card.querySelector(".deleteBtn").onclick=async()=>{
          if(confirm(`üóë Tens certeza que queres eliminar ${p.name}?`)){
            try{
              await deleteDoc(doc(db,"users",p.id));
              await addLog("eliminou","perfil",p.name);
              popup("üóë Perfil eliminado!");
              card.remove();
            }catch(e){ popup("‚ùå Erro ao eliminar!"); }
          }
        };

        grid.appendChild(card);
      });
    }

    search.addEventListener("input",()=>{
      const t=search.value.toLowerCase();
      const filtered=allProfiles.filter(p=>
        (p.name||"").toLowerCase().includes(t) ||
        (p.division||"").toLowerCase().includes(t)
      );
      render(filtered);
    });

    loadProfiles();
  </script>
</body>
</html>
