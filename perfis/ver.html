<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Perfil da Aura â€” Sistema AURA ğŸ’œ</title>

  <link rel="icon" href="../Aurinha.png" />
  <link rel="stylesheet" href="../style.css" />

  <style>
    .page-container { padding: 2rem; }
    .topbar {
      display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between;
      margin-bottom:1.2rem;
    }
    .topbar h1 { margin:0; }
    .actions { display:flex; gap:8px; flex-wrap:wrap; }
    .btn {
      background: linear-gradient(90deg,#9b4dff,#b86bff);
      border: none; border-radius: 10px; color: #fff; font-weight: 600;
      padding: 8px 14px; cursor: pointer; transition: .2s;
      box-shadow: 0 0 10px rgba(180,107,255,.25);
    }
    .btn:hover { transform: translateY(-1px); box-shadow: 0 10px 22px rgba(180,107,255,.35); }
    .searchbar { margin: .5rem 0 1rem; display:flex; gap:8px; }
    .searchbar input {
      flex:1; padding:.8rem 1rem; border-radius:12px; border:none;
      background: rgba(255,255,255,.08); color:#fff; outline:none;
      box-shadow: 0 0 10px rgba(180,107,255,.25);
    }

    .grid {
      display:grid; grid-template-columns: repeat(auto-fill, minmax(250px,1fr));
      gap: 16px;
    }
    .card {
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.06);
      border-radius: 14px; padding: 1rem; text-align:center;
      box-shadow: 0 10px 22px rgba(180,107,255,.15);
    }
    .card img {
      width: 84px; height: 84px; border-radius: 50%; object-fit: cover;
      box-shadow: 0 0 12px rgba(180,107,255,.35);
    }
    .card h3 { margin: .6rem 0 .2rem; }
    .card p { margin: .2rem 0; opacity: .9; }
    .buttons { display:flex; flex-wrap:wrap; gap:8px; justify-content:center; margin-top:.6rem; }
    .btn-danger { background: linear-gradient(90deg,#ff4d6d,#ff7c6b); }
    .btn-soft { background: rgba(255,255,255,.08); color:#fff; border:1px solid rgba(255,255,255,.08); }

    /* Modal & Toast */
    .aura-modal-wrap{ position:fixed; inset:0; background:rgba(0,0,0,.55); display:flex; align-items:center; justify-content:center; padding:20px; z-index:1100; animation: fadeIn .15s ease; }
    .aura-modal{ width:min(520px,95vw); background: rgba(20,0,40,.92); border:1px solid rgba(255,255,255,.08); border-radius:16px; padding:18px; color:#fff; box-shadow:0 18px 40px rgba(180,107,255,.35); transform: translateY(6px); animation: popIn .18s ease forwards; }
    .aura-modal h3{ margin:0 0 6px; }
    .aura-modal p{ margin:.25rem 0 .8rem; opacity:.9; }
    .aura-modal .row{ display:flex; gap:10px; justify-content:flex-end; }
    .aura-modal .aura-btn{ background: rgba(255,255,255,.08); color:#fff; border:1px solid rgba(255,255,255,.08); padding:.6rem .9rem; border-radius:10px; cursor:pointer; font-weight:600; }
    .aura-modal .aura-btn.primary{ background: linear-gradient(135deg,#b46bff,#9f4dff); border:none; box-shadow: 0 8px 18px rgba(159,77,255,.35); }
    .aura-modal .aura-btn.danger{ background: linear-gradient(135deg,#ff4d6d,#ff7c6b); border:none; box-shadow: 0 8px 18px rgba(255,124,107,.35); }
    @keyframes fadeIn { from{opacity:0} to{opacity:1} } @keyframes popIn { to{ transform: translateY(0) } }
    .aura-toast{ position:fixed; right:16px; bottom:16px; z-index:1200; display:flex; gap:10px; align-items:center; background: rgba(20,0,40,.95); border:1px solid rgba(255,255,255,.08); padding:.7rem 1rem; border-radius:12px; color:#fff; box-shadow:0 10px 24px rgba(180,107,255,.35); animation: fadeIn .15s ease; }
    .aura-toast.success{ border-color: rgba(140,255,199,.35); }
    .aura-toast.error{ border-color: rgba(255,124,107,.35); }
    .aura-toast .icon{ font-size:1.2rem; }

    .muted { opacity:.8; }
  </style>
</head>

<body>
  <!-- MENU LATERAL -->
  <div class="sidebar">
    <h2 class="logo">SISTEMA AURA</h2>
    <span id="agentNameDisplay" class="agent-display">Agente: -</span>

    <ul>
      <li><a href="../dashboard.html" class="navlink active"><span class="icon">ğŸ </span><span class="label">Dashboard</span></a></li>
      <li><a href="../pesquisa/ver.html" class="navlink"><span class="icon">ğŸ”</span><span class="label">Pesquisa Geral</span></a></li>
      <li><a href="../perfis/ver.html" class="navlink"><span class="icon">ğŸ‘‘</span><span class="label">Perfil da Aura</span></a></li>
      <li><a href="../people/ver.html" class="navlink"><span class="icon">ğŸ§</span><span class="label">Pessoas</span></a></li>
      <li><a href="../casos/ver.html" class="navlink"><span class="icon">ğŸ“</span><span class="label">Casos</span></a></li>
      <li><a href="../investigacoes/ver.html" class="navlink"><span class="icon">ğŸ•µï¸</span><span class="label">InvestigaÃ§Ãµes</span></a></li>
      <li><a href="../veiculos/ver.html" class="navlink"><span class="icon">ğŸï¸</span><span class="label">VeÃ­culos</span></a></li>
      <li><a href="../facc/ver.html" class="navlink"><span class="icon">âš”ï¸</span><span class="label">FacÃ§Ãµes</span></a></li>
      <li><a href="../perimetro/ver.html" class="navlink"><span class="icon">ğŸ“</span><span class="label">PerÃ­metro de AÃ§Ãµes</span></a></li>
      <li><a href="../reunioes/ver.html" class="navlink"><span class="icon">ğŸ—“ï¸</span><span class="label">ReuniÃµes</span></a></li>
    </ul>

    <button id="logoutBtn">Sair</button>
  </div>

  <!-- CONTEÃšDO -->
  <div class="main-content">
    <div class="page-container">
      <div class="topbar">
        <h1>Perfil da Aura</h1>
        <div class="actions">
          <button id="backBtn" class="btn btn-soft">â¬…ï¸ Voltar</button>
          <button id="archivedBtn" class="btn btn-soft">ğŸ—ƒï¸ Arquivados</button>
          <button id="newBtn" class="btn only-editor">â• Novo Perfil</button>
        </div>
      </div>

      <div class="searchbar">
        <input id="searchBar" placeholder="Pesquisar por nome ou divisÃ£o..." />
      </div>

      <div id="profilesGrid" class="grid"></div>
    </div>
  </div>

  <!-- FIREBASE -->
  <script type="module">
    import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import {
      getFirestore, collection, getDocs, addDoc, deleteDoc, updateDoc, doc, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";
    import { firebaseConfig } from "../firebaseConfig.js";

    const app = getApps().length ? getApps()[0] : initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const grid = document.getElementById("profilesGrid");
    const search = document.getElementById("searchBar");
    const isAdmin = localStorage.getItem("isAdmin") === "true";
    const role = (localStorage.getItem("userRole") || "").toLowerCase();
    const canEdit = role === "investigador" || isAdmin;
    let allProfiles = [];

    // BotÃµes de navegaÃ§Ã£o
    document.getElementById("backBtn").onclick = () => window.location.href = "../dashboard.html";
    document.getElementById("archivedBtn").onclick = () => window.location.href = "arquivados.html";
    document.getElementById("newBtn").onclick = () => window.location.href = "criar.html";

    // UI helpers
    function toast(msg, type="success"){
      const t=document.createElement("div");
      t.className=`aura-toast ${type}`;
      t.innerHTML=`<span class="icon">${type==="success"?"âœ…":type==="error"?"âš ï¸":"ğŸ’œ"}</span><span>${msg}</span>`;
      document.body.appendChild(t);
      setTimeout(()=>{t.style.opacity="0";setTimeout(()=>t.remove(),220);},1800);
    }

    async function addLog(action, itemType, itemName){
      try{await addDoc(collection(db,"logs"),{action,itemType,itemName:itemName||"",user:localStorage.getItem("selectedAgent")||"Desconhecido",timestamp:serverTimestamp()});}
      catch(e){console.warn("log fail",e);}
    }

    // Carregar perfis
    async function loadProfiles(){
      const snap = await getDocs(collection(db,"users"));
      allProfiles = snap.docs.map(d=>({id:d.id,...d.data()}));
      render(allProfiles);
    }

    function render(list){
      grid.innerHTML="";
      if(!list.length){grid.innerHTML="<p class='muted'>Nenhum perfil encontrado.</p>";return;}
      list.forEach(p=>{
        const card=document.createElement("div");
        card.className="card";
        card.innerHTML=`
          <img src="${p.photoURL||'../Aurinha.png'}" alt="avatar">
          <h3>${p.name||'Sem nome'}</h3>
          <p><b>DivisÃ£o:</b> ${p.division||'-'}</p>
          <p><b>Cargo:</b> ${p.role||'-'}</p>
          <div class="buttons">
            <button class="btn btn-soft viewBtn">ğŸ‘ Ver</button>
            ${canEdit?`<button class="btn only-editor editBtn">ğŸ–Š Editar</button>
                       <button class="btn only-editor archiveBtn">ğŸ“¦ Arquivar</button>`:""}
            ${isAdmin?`<button class="btn btn-danger only-admin deleteBtn">ğŸ—‘ Eliminar</button>
                       <button class="btn only-admin toggleInvBtn">${p.role==="investigador"?"Retirar Investigador":"Dar Investigador"}</button>
                       <button class="btn only-admin toggleAdminBtn">${p.isAdmin===true?"Retirar Admin":"Dar Admin"}</button>`:""}
          </div>`;
        
        card.querySelector(".viewBtn").onclick=()=>{alert(`Nome: ${p.name}\nDivisÃ£o: ${p.division||"-"}\nCargo: ${p.role||"-"}`)};
        if(canEdit) card.querySelector(".editBtn")?.addEventListener("click",()=>{window.location.href=`editar.html?id=${p.id}`;});
        if(canEdit) card.querySelector(".archiveBtn")?.addEventListener("click",async()=>{
          await addDoc(collection(db,"users_archived"),{...p,archivedAt:new Date()});
          await deleteDoc(doc(db,"users",p.id));
          await addLog("arquivou","perfil",p.name);
          card.remove();toast("Perfil arquivado!","success");
        });
        if(isAdmin) card.querySelector(".deleteBtn")?.addEventListener("click",async()=>{
          await deleteDoc(doc(db,"users",p.id));await addLog("eliminou","perfil",p.name);
          card.remove();toast("Perfil eliminado!","success");
        });
        if(isAdmin) card.querySelector(".toggleInvBtn")?.addEventListener("click",async()=>{
          const newRole=p.role==="investigador"?"": "investigador";
          await updateDoc(doc(db,"users",p.id),{role:newRole});
          await addLog("alterou tag","investigador",p.name);
          toast("Tag de Investigador atualizada!","success");
          loadProfiles();
        });
        if(isAdmin) card.querySelector(".toggleAdminBtn")?.addEventListener("click",async()=>{
          const newVal=!(p.isAdmin===true);
          await updateDoc(doc(db,"users",p.id),{isAdmin:newVal});
          await addLog("alterou","admin",p.name);
          toast("Status de Admin atualizado!","success");
          loadProfiles();
        });
        grid.appendChild(card);
      });
    }

    search.addEventListener("input",(e)=>{
      const t=(e.target.value||"").toLowerCase().trim();
      const filtered=allProfiles.filter(p=>(p.name||"").toLowerCase().includes(t)||(p.division||"").toLowerCase().includes(t));
      render(filtered);
    });

    loadProfiles();
  </script>

  <script>
  (function(){
    const agent=localStorage.getItem("selectedAgent")||"Desconhecido";
    document.getElementById("agentNameDisplay").textContent=`Agente: ${agent}`;
    document.getElementById("logoutBtn").onclick=()=>{
      ["username","selectedAgent","userRole","userCode","isAdmin"].forEach(k=>localStorage.removeItem(k));
      window.location.href="../select.html";
    };
  })();
  </script>
</body>
</html>
