<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Perfis Arquivados - AURA</title>
  <link rel="icon" href="../../Aurinha.png" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;500;700&display=swap" rel="stylesheet" />

  <style>
    body {
      background: radial-gradient(circle at top left,#1a001f,#000);
      font-family:'Poppins',sans-serif;
      color:#fff;
      margin:0;
      padding:30px;
    }

    .top-bar {
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:25px;
    }

    .top-bar h2 {
      color:#d6b2ff;
      text-shadow:0 0 10px rgba(180,0,255,0.7);
      margin:0;
      flex:1;
      text-align:center;
    }

    .top-bar button {
      background:linear-gradient(90deg,#9b4dff,#b86bff);
      border:none;
      border-radius:10px;
      color:#fff;
      font-weight:600;
      padding:8px 16px;
      cursor:pointer;
      transition:0.3s;
      box-shadow:0 0 10px rgba(180,0,255,0.4);
    }

    .top-bar button:hover {
      transform:scale(1.05);
      background:linear-gradient(90deg,#b86bff,#d6aaff);
    }

    #searchBar {
      display:block;
      margin:0 auto 30px;
      width:300px;
      padding:10px;
      border:none;
      border-radius:10px;
      background:rgba(255,255,255,0.1);
      color:#fff;
      text-align:center;
    }

    #searchBar:focus {
      outline:none;
      box-shadow:0 0 10px rgba(180,0,255,0.6);
      background:rgba(255,255,255,0.15);
    }

    .grid {
      display:grid;
      grid-template-columns:repeat(auto-fill,minmax(220px,1fr));
      gap:20px;
    }

    .card {
      background:rgba(50,0,80,0.45);
      border:1px solid rgba(200,150,255,0.3);
      border-radius:20px;
      padding:15px;
      box-shadow:0 0 20px rgba(180,0,255,0.3);
      transition:all .3s ease;
      text-align:center;
    }

    .card:hover {
      transform:scale(1.05);
      box-shadow:0 0 25px rgba(180,0,255,0.6);
    }

    .avatar {
      width:80px;
      height:80px;
      border-radius:50%;
      object-fit:cover;
      margin-bottom:10px;
      box-shadow:0 0 10px rgba(180,0,255,0.4);
    }

    .card h3 {
      margin:5px 0;
      color:#d6b2ff;
    }

    .card p {
      font-size:.85rem;
      margin:3px 0;
    }

    .buttons {
      margin-top:10px;
      display:flex;
      justify-content:center;
      gap:10px;
    }

    .buttons button {
      background:linear-gradient(90deg,#9b4dff,#b86bff);
      border:none;
      border-radius:8px;
      color:#fff;
      padding:5px 10px;
      cursor:pointer;
      transition:.3s;
    }

    .buttons button:hover {
      transform:scale(1.05);
      background:linear-gradient(90deg,#b86bff,#d6aaff);
    }

    /* Popup neon */
    .neon-popup {
      position:fixed;
      bottom:30px;
      left:50%;
      transform:translateX(-50%);
      background:linear-gradient(90deg,#9b4dff,#b86bff);
      padding:12px 25px;
      border-radius:15px;
      color:#fff;
      font-weight:500;
      box-shadow:0 0 20px rgba(180,0,255,0.6);
      text-align:center;
      z-index:9999;
      animation:fadeInUp .3s ease;
    }

    @keyframes fadeInUp {
      from {opacity:0; transform:translate(-50%,10px);}
      to {opacity:1; transform:translate(-50%,0);}
    }

    /* Modal */
    .confirm-overlay {
      position:fixed;
      top:0;
      left:0;
      width:100%;
      height:100%;
      background:rgba(0,0,0,0.7);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:10000;
      animation:fadeIn .3s ease;
    }

    .confirm-box {
      background:rgba(40,0,60,0.95);
      border:1px solid rgba(200,150,255,0.4);
      border-radius:15px;
      padding:25px;
      text-align:center;
      box-shadow:0 0 25px rgba(180,0,255,0.7);
      width:300px;
      animation:fadeInUp .3s ease;
    }

    .confirm-box h3 { color:#d6b2ff; margin-bottom:15px; }

    .confirm-buttons {
      display:flex;
      justify-content:space-around;
      margin-top:20px;
    }

    .confirm-buttons button {
      background:linear-gradient(90deg,#9b4dff,#b86bff);
      border:none;
      border-radius:8px;
      color:#fff;
      padding:8px 20px;
      cursor:pointer;
      transition:.3s;
    }

    .confirm-buttons button:hover {
      transform:scale(1.05);
      background:linear-gradient(90deg,#b86bff,#d6aaff);
    }

    .confirm-buttons .cancel {
      background:linear-gradient(90deg,#444,#666);
    }
  </style>
</head>
<body>
  <div class="top-bar">
    <button id="backBtn">‚¨Ö Voltar</button>
    <h2>Perfis Arquivados</h2>
    <div style="width:120px;"></div>
  </div>

  <input type="text" id="searchBar" placeholder="üîç Pesquisar por nome ou divis√£o...">
  <div class="grid" id="usersGrid"></div>

  <script type="module">
    import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import { getFirestore, collection, getDocs, setDoc, deleteDoc, doc } 
      from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";
    import { firebaseConfig } from "../../firebaseConfig.js";

    const app = getApps().length===0 ? initializeApp(firebaseConfig) : getApps()[0];
    const db = getFirestore(app);

    const grid = document.getElementById("usersGrid");
    const search = document.getElementById("searchBar");
    let allUsers = [];

    function showPopup(msg){
      const popup=document.createElement("div");
      popup.className="neon-popup";
      popup.textContent=msg;
      document.body.appendChild(popup);
      setTimeout(()=>popup.remove(),3000);
    }

    async function loadArchived(){
      const snap = await getDocs(collection(db,"users_archived"));
      allUsers = snap.docs.map(d=>({ id:d.id, ...d.data() }));
      render(allUsers);
    }

    function render(list){
      grid.innerHTML="";
      if(!list.length){
        grid.innerHTML="<p style='text-align:center;opacity:0.7'>Nenhum perfil arquivado.</p>";
        return;
      }

      list.forEach(u=>{
        const card=document.createElement("div");
        card.className="card";
        card.innerHTML=`
          <img src="${u.avatar || '../../Aurinha.png'}" class="avatar">
          <h3>${u.name || 'Sem nome'}</h3>
          <p><b>Cargo:</b> ${u.role || '‚Äî'}</p>
          <p><b>Divis√£o:</b> ${u.division || '‚Äî'}</p>
          <p><b>Arquivado em:</b> ${u.archivedAt?.toDate ? u.archivedAt.toDate().toLocaleDateString() : '‚Äî'}</p>
          <div class="buttons">
            <button class="restoreBtn">‚ôªÔ∏è Restaurar</button>
          </div>
        `;

        card.querySelector(".restoreBtn").addEventListener("click",()=>{
          const overlay=document.createElement("div");
          overlay.className="confirm-overlay";
          overlay.innerHTML=`
            <div class="confirm-box">
              <h3>‚ôªÔ∏è Desejas restaurar este perfil?</h3>
              <div class="confirm-buttons">
                <button class="confirm">Confirmar</button>
                <button class="cancel">Cancelar</button>
              </div>
            </div>`;
          document.body.appendChild(overlay);

          overlay.querySelector(".confirm").addEventListener("click",async()=>{
            try{
              const payload={...u};
              delete payload.archivedAt;
              await setDoc(doc(db,"users",u.id),payload,{merge:true});
              await deleteDoc(doc(db,"users_archived",u.id));
              showPopup("‚úÖ Perfil restaurado!");
              overlay.remove();
              card.remove();
            }catch(e){
              console.error(e);
              showPopup("‚ùå Erro ao restaurar!");
            }
          });

          overlay.querySelector(".cancel").addEventListener("click",()=>overlay.remove());
        });

        grid.appendChild(card);
      });
    }

    search.addEventListener("input",()=>{
      const t=search.value.toLowerCase();
      const filtered=allUsers.filter(u=>
        (u.name||"").toLowerCase().includes(t)||
        (u.division||"").toLowerCase().includes(t)
      );
      render(filtered);
    });

    document.getElementById("backBtn").addEventListener("click",()=>window.location.href="ver.html");

    loadArchived();
  </script>
</body>
</html>
