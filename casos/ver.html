<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Casos ‚Äî Sistema AURA üíú</title>

  <link rel="icon" href="../Aurinha.png" />
  <link rel="stylesheet" href="../style.css" />

  <style>
    .page-container { padding: 2rem; }
    .topbar { display:flex; justify-content:space-between; align-items:center; margin-bottom:1.4rem; gap:8px; flex-wrap:wrap; }
    .actions { display:flex; gap:8px; flex-wrap:wrap; }
    .btn {
      background: linear-gradient(90deg,#9b4dff,#b86bff);
      border:none; border-radius:10px; color:#fff; font-weight:600;
      padding:8px 14px; cursor:pointer; transition:.2s;
      box-shadow:0 0 10px rgba(180,107,255,.25);
    }
    .btn:hover { transform:translateY(-1px); box-shadow:0 10px 22px rgba(180,107,255,.35); }
    .btn-soft { background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.08); }
    .btn-danger { background: linear-gradient(90deg,#ff4d6d,#ff7c6b); }

    .searchbar { margin:.5rem 0 1rem; display:flex; gap:8px; }
    .searchbar input {
      flex:1; padding:.8rem 1rem; border-radius:12px; border:none;
      background:rgba(255,255,255,.08); color:#fff; outline:none;
      box-shadow:0 0 10px rgba(180,107,255,.25);
    }

    .grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(300px,1fr)); gap: 16px; }
    .card {
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.06);
      border-radius: 16px;
      padding: 14px;
      box-shadow: 0 10px 22px rgba(180,107,255,.15);
      transition:.2s;
    }
    .card:hover { transform:translateY(-3px); box-shadow:0 12px 24px rgba(180,107,255,.25); }

    .thumb {
      width: 80px; height: 80px; border-radius: 10px; object-fit: cover;
      display:block; margin: 2px auto 10px; box-shadow:0 0 12px rgba(180,107,255,.35);
      background:#1d0a33;
    }
    .thumb-file {
      width: 80px; height: 80px; border-radius: 10px; display:flex; align-items:center; justify-content:center;
      margin: 2px auto 10px; box-shadow:0 0 12px rgba(180,107,255,.35);
      background:rgba(255,255,255,.08); font-weight:700;
    }
    .file-name {
      text-align:center; font-size:.85rem; opacity:.9; margin-top:-6px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }

    .card h3 { margin:.35rem 0 .2rem; color:#fff; text-align:center; }
    .meta { font-size:.95rem; color:#ddd; margin:2px 0; text-align:center; }
    .meta b{ color:#fff; }
    .estado { margin-top:6px; font-weight:600; text-transform:uppercase; letter-spacing:.5px; color:#b86bff; text-align:center; }
    .buttons { display:flex; gap:8px; margin-top:.8rem; flex-wrap:wrap; justify-content:center; }

    /* Toast */
    .aura-toast{
      position:fixed; right:16px; bottom:16px; z-index:1200; display:flex; gap:10px; align-items:center;
      background:rgba(20,0,40,.95); border:1px solid rgba(255,255,255,.08);
      padding:.7rem 1rem; border-radius:12px; color:#fff; box-shadow:0 10px 24px rgba(180,107,255,.35);
      animation:fadeIn .15s ease;
    }
    .aura-toast.success{ border-color:rgba(140,255,199,.35); }
    .aura-toast.error{ border-color:rgba(255,124,107,.35); }
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}

    /* Modal */
    .aura-modal-wrap{ position:fixed; inset:0; background:rgba(0,0,0,.55); display:flex; align-items:center; justify-content:center; padding:20px; z-index:1400; animation:fadeIn .15s ease;}
    .aura-modal{ width:min(560px,95vw); background:rgba(20,0,40,.92); border:1px solid rgba(255,255,255,.08); border-radius:16px; padding:18px; color:#fff; box-shadow:0 18px 40px rgba(180,107,255,.35);}
    .aura-modal h3{ margin:0 0 6px; }
    .aura-modal p{ margin:.25rem 0 .8rem; opacity:.9;}
    .aura-modal .row{ display:flex; gap:10px; justify-content:flex-end;}
    .aura-btn{ background:rgba(255,255,255,.08); color:#fff; border:1px solid rgba(255,255,255,.08); padding:.6rem .9rem; border-radius:10px; cursor:pointer; font-weight:600;}
    .aura-btn.primary{ background: linear-gradient(135deg,#b46bff,#9f4dff); border:none;}
    .aura-btn.danger{ background: linear-gradient(135deg,#ff4d6d,#ff7c6b); border:none;}

    .muted{opacity:.8;}
    .hidden{display:none;}
  </style>
</head>

<body>
  <!-- SIDEBAR -->
  <div class="sidebar">
    <h2 class="logo">SISTEMA AURA</h2>
    <ul>
      <li><a href="../dashboard.html" class="navlink active"><span class="icon">üè†</span><span class="label">Dashboard</span></a></li>
      <li><a href="../pesquisa/ver.html" class="navlink"><span class="icon">üîç</span><span class="label">Pesquisa Geral</span></a></li>
      <li><a href="../perfis/ver.html" class="navlink"><span class="icon">üëë</span><span class="label">Perfil da Aura</span></a></li>
      <li><a href="../people/ver.html" class="navlink"><span class="icon">üßç</span><span class="label">Pessoas</span></a></li>
      <li><a href="../casos/ver.html" class="navlink"><span class="icon">üìÅ</span><span class="label">Casos</span></a></li>
      <li><a href="../investigacoes/ver.html" class="navlink"><span class="icon">üïµÔ∏è</span><span class="label">Investiga√ß√µes</span></a></li>
      <li><a href="../veiculos/ver.html" class="navlink"><span class="icon">üèéÔ∏è</span><span class="label">Ve√≠culos</span></a></li>
      <li><a href="../facc/ver.html" class="navlink"><span class="icon">‚öîÔ∏è</span><span class="label">Fac√ß√µes</span></a></li>
      <li><a href="../perimetro/ver.html" class="navlink"><span class="icon">üìç</span><span class="label">Per√≠metro de A√ß√µes</span></a></li>
      <li><a href="../reunioes/ver.html" class="navlink"><span class="icon">üóìÔ∏è</span><span class="label">Reuni√µes</span></a></li>
    </ul>
    <button id="logoutBtn">Sair</button>
  </div>

  <!-- CONTE√öDO -->
  <div class="main-content">
    <div class="page-container">
      <div class="topbar">
        <h1>Casos</h1>
        <div class="actions">
          <button id="archivedBtn" class="btn btn-soft">üóÉ Arquivados</button>
          <button id="newBtn" class="btn only-editor">‚ûï Novo Caso</button>
        </div>
      </div>

      <div class="searchbar">
        <input id="searchBar" placeholder="Pesquisar por t√≠tulo, respons√°vel, envolvidos, ve√≠culos ou fac√ß√µes..." />
      </div>

      <div id="casesGrid" class="grid"></div>
    </div>
  </div>

  <!-- FIREBASE -->
  <script type="module">
    import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import {
      getFirestore, collection, getDocs, deleteDoc, doc, updateDoc, query, orderBy
    } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";
    import { firebaseConfig } from "../firebaseConfig.js";

    const app = getApps().length ? getApps()[0] : initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const grid   = document.getElementById("casesGrid");
    const search = document.getElementById("searchBar");
    let allCases = [];

    // Permiss√µes
    const isAdmin = localStorage.getItem("isAdmin") === "true";
    const roleStr = (localStorage.getItem("userRole") || "").toLowerCase();
    const canEdit = isAdmin || roleStr === "investigador";

    // Navega√ß√£o
    document.getElementById("archivedBtn").onclick = ()=> window.location.href="arquivados.html";
    document.getElementById("newBtn").onclick = ()=> window.location.href="criar.html";

    // Toast
    function toast(msg,type="success"){
      const t=document.createElement("div");
      t.className=`aura-toast ${type}`;
      t.innerHTML=`<span>${type==="success"?"‚úÖ":"‚ö†Ô∏è"}</span><span>${msg}</span>`;
      document.body.appendChild(t);
      setTimeout(()=>{ t.style.opacity="0"; setTimeout(()=>t.remove(),260); }, 1900);
    }

    // Modal confirmar
    function confirmModal({title="Confirmar", message="Tens a certeza?", okText="Confirmar", variant="primary"}){
      return new Promise(resolve=>{
        const wrap=document.createElement("div");
        wrap.className="aura-modal-wrap";
        wrap.innerHTML=`
          <div class="aura-modal">
            <h3>${title}</h3>
            <p>${message}</p>
            <div class="row">
              <button class="aura-btn">Cancelar</button>
              <button class="aura-btn ${variant==='danger'?'danger':'primary'}">${okText}</button>
            </div>
          </div>`;
        document.body.appendChild(wrap);
        const [cancelBtn, okBtn] = wrap.querySelectorAll("button");
        const close = (v)=>{ wrap.remove(); resolve(v); };
        cancelBtn.onclick = ()=> close(false);
        okBtn.onclick     = ()=> close(true);
        wrap.addEventListener("click",(e)=>{ if(e.target===wrap) close(false); });
      });
    }

    // Carregar casos (mais recentes primeiro)
    async function loadCases(){
      try{
        const q = query(collection(db,"casos"), orderBy("createdAt","desc"));
        const snap = await getDocs(q);
        allCases = snap.docs.map(d => ({ id:d.id, ...d.data() }));
      }catch{
        const snap = await getDocs(collection(db,"casos"));
        allCases = snap.docs.map(d => ({ id:d.id, ...d.data() }));
        allCases.sort((a,b)=>{
          const ta=a.createdAt?.seconds||0, tb=b.createdAt?.seconds||0;
          return tb-ta;
        });
      }
      render(allCases);
    }

    function isImageLike(url, fileType){
      if (fileType && fileType.startsWith("image/")) return true;
      return /\.(png|jpe?g|gif|webp|bmp|svg)$/i.test(url||"");
    }

    function caseCard(c){
      const isImg = isImageLike(c.photoURL, c.fileType);
      const thumbEl = isImg
        ? `<img class="thumb" src="${c.photoURL}" alt="anexo">`
        : (c.photoURL ? `<div class="thumb-file">üìÑ</div><div class="file-name" title="${c.fileName||"documento"}">${(c.fileName||"documento")}</div>` : "");

      const estadoStyle = c.estado==="arquivado" ? "opacity:.65;" : "";
      const card = document.createElement("div");
      card.className="card";
      card.style = estadoStyle;
      card.innerHTML = `
        ${thumbEl}
        <h3>${c.titulo || "Sem t√≠tulo"}</h3>
        <div class="meta"><b>Respons√°vel:</b> ${c.responsavel || "-"}</div>
        ${c.envolvidos?.length ? `<div class="meta"><b>Envolvidos:</b> ${c.envolvidos.join(", ")}</div>` : ""}
        ${c.veiculos?.length ? `<div class="meta"><b>Ve√≠culos:</b> ${c.veiculos.join(", ")}</div>` : ""}
        ${c.faccoes?.length ? `<div class="meta"><b>Fac√ß√µes:</b> ${c.faccoes.join(", ")}</div>` : ""}
        <div class="estado">${(c.estado || "ativo").toUpperCase()}</div>
        <div class="buttons">
          <button class="btn btn-soft viewBtn">üëÅ Ver</button>
          ${canEdit ? `
            ${c.estado!=="arquivado" ? `
              <button class="btn btn-soft editBtn">üñä Editar</button>
              <button class="btn btn-soft archiveBtn">üì¶ Arquivar</button>` :
              `<button class="btn btn-soft reopenBtn">üóÉ Reabrir</button>`
            }
            <button class="btn btn-danger delBtn">üóë Eliminar</button>
          ` : ""}
        </div>
      `;

      // Ver (modal com preview grande)
      card.querySelector(".viewBtn").onclick = ()=>{
        const wrap = document.createElement("div");
        wrap.className="aura-modal-wrap";
        const fileBlock = c.photoURL ? (isImg
          ? `<p><img src="${c.photoURL}" alt="anexo" style="max-width:100%; border-radius:12px; box-shadow:0 0 12px rgba(180,107,255,.35);" /></p>`
          : `<p>üìÑ ${c.fileName || "documento"} ‚Äî <a href="${c.photoURL}" target="_blank" style="color:#bfa7ff; text-decoration:underline;">Abrir</a></p>`)
          : "";

        wrap.innerHTML=`
          <div class="aura-modal">
            <h3>${c.titulo || "Sem t√≠tulo"}</h3>
            <p><b>Respons√°vel:</b> ${c.responsavel || "-"}</p>
            ${c.envolvidos?.length ? `<p><b>Envolvidos:</b> ${c.envolvidos.join(", ")}</p>` : ""}
            ${c.veiculos?.length ? `<p><b>Ve√≠culos:</b> ${c.veiculos.join(", ")}</p>` : ""}
            ${c.faccoes?.length ? `<p><b>Fac√ß√µes:</b> ${c.faccoes.join(", ")}</p>` : ""}
            <p><b>Descri√ß√£o:</b><br>${c.descricao || "Sem descri√ß√£o."}</p>
            ${fileBlock}
            <div class="row"><button class="aura-btn primary">Fechar</button></div>
          </div>`;
        wrap.querySelector("button").onclick = ()=> wrap.remove();
        wrap.addEventListener("click",(e)=>{ if(e.target===wrap) wrap.remove(); });
        document.body.appendChild(wrap);
      };

      // Editar
      card.querySelector(".editBtn")?.addEventListener("click", ()=> window.location.href=`editar.html?id=${c.id}`);

      // Arquivar
      card.querySelector(".archiveBtn")?.addEventListener("click", async ()=>{
        const ok = await confirmModal({
          title:"Arquivar caso",
          message:`Queres arquivar <b>${c.titulo || c.id}</b>?`,
          okText:"Arquivar"
        });
        if(!ok) return;
        try{
          await updateDoc(doc(db,"casos",c.id), { estado:"arquivado" });
          toast("Caso arquivado!");
          loadCases();
        }catch(e){ console.error(e); toast("Erro ao arquivar: " + e.message, "error"); }
      });

      // Reabrir
      card.querySelector(".reopenBtn")?.addEventListener("click", async ()=>{
        const ok = await confirmModal({
          title:"Reabrir caso",
          message:`Desejas reabrir <b>${c.titulo || c.id}</b>?`,
          okText:"Reabrir"
        });
        if(!ok) return;
        try{
          await updateDoc(doc(db,"casos",c.id), { estado:"ativo" });
          toast("Caso reaberto!");
          loadCases();
        }catch(e){ console.error(e); toast("Erro ao reabrir: " + e.message, "error"); }
      });

      // Eliminar
      card.querySelector(".delBtn")?.addEventListener("click", async ()=>{
        const ok = await confirmModal({
          title:"Eliminar caso",
          message:`Esta a√ß√£o √© permanente. Eliminar <b>${c.titulo || c.id}</b>?`,
          okText:"Eliminar", variant:"danger"
        });
        if(!ok) return;
        try{
          await deleteDoc(doc(db,"casos",c.id));
          toast("Caso eliminado!");
          card.remove();
        }catch(e){ console.error(e); toast("Erro ao eliminar: " + e.message, "error"); }
      });

      return card;
    }

    function render(list){
      grid.innerHTML="";
      if(!list.length){ grid.innerHTML="<p class='muted'>Nenhum caso registado.</p>"; return; }
      list.forEach(c=>grid.appendChild(caseCard(c)));
    }

    // Pesquisa
    search.addEventListener("input", (e)=>{
      const t=(e.target.value||"").toLowerCase().trim();
      const filtered = allCases.filter(c=>{
        return (c.titulo||"").toLowerCase().includes(t) ||
               (c.responsavel||"").toLowerCase().includes(t) ||
               (Array.isArray(c.envolvidos) && c.envolvidos.join(", ").toLowerCase().includes(t)) ||
               (Array.isArray(c.veiculos) && c.veiculos.join(", ").toLowerCase().includes(t)) ||
               (Array.isArray(c.faccoes)  && c.faccoes.join(", ").toLowerCase().includes(t));
      });
      render(filtered);
    });

    loadCases();
  </script>

  <!-- PERFIL + SAIR + PERMISS√ïES VISUAIS -->
  <script>
    (function(){
      const logoutBtn = document.getElementById("logoutBtn");
      if (logoutBtn) {
        logoutBtn.addEventListener("click", () => {
          ["username","selectedAgent","userRole","userCode","isAdmin"].forEach(k => localStorage.removeItem(k));
          window.location.href = "../select.html";
        });
      }

      const isAdmin = localStorage.getItem("isAdmin")==="true";
      const role = (localStorage.getItem("userRole")||"").toLowerCase();
      const canEdit = isAdmin || role==="investigador";

      if (!canEdit) {
        document.querySelectorAll(".only-editor").forEach(el => el.style.display = "none");
      }
    })();
  </script>
</body>
</html>
