<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Editar Caso ‚Äî Sistema AURA üíú</title>

  <link rel="icon" href="../Aurinha.png"/>
  <link rel="stylesheet" href="../style.css"/>

  <style>
    .page-container { padding:2rem; max-width:1100px; margin:0 auto; }
    .topbar { display:flex; justify-content:space-between; align-items:center; gap:8px; flex-wrap:wrap; margin-bottom:1.4rem; }
    .row-actions { display:flex; gap:8px; flex-wrap:wrap; }
    .card { background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.06); border-radius:16px; padding:22px; box-shadow:0 10px 22px rgba(180,107,255,.15); }

    label { font-weight:600; opacity:.95; margin-bottom:6px; display:block; }
    input, textarea {
      width:100%; padding:.8rem 1rem; border-radius:12px; border:none; outline:none;
      background:rgba(255,255,255,.08); color:#fff; box-shadow:0 0 10px rgba(180,107,255,.18);
      margin-bottom:1rem;
    }
    textarea { resize:vertical; min-height:120px; }

    /* Chips multi-select */
    .ms { margin-bottom:1rem; }
    .ms .box {
      display:flex; gap:8px; flex-wrap:wrap; align-items:center;
      min-height:48px; padding:8px; border-radius:12px;
      background:rgba(255,255,255,.08); box-shadow:0 0 10px rgba(180,107,255,.18);
    }
    .ms .chip {
      display:inline-flex; align-items:center; gap:6px;
      background:linear-gradient(90deg,#9b4dff,#b86bff);
      color:#fff; padding:6px 10px; border-radius:999px; font-weight:600; font-size:.9rem;
      box-shadow:0 6px 14px rgba(180,107,255,.25);
    }
    .ms .chip button {
      background:rgba(255,255,255,.25); border:none; color:#fff; width:20px; height:20px;
      border-radius:50%; cursor:pointer; font-weight:700; line-height:20px;
    }
    .ms .input-wrap { flex:1; min-width:200px; position:relative; }
    .ms input[type="text"] {
      margin:0; background:transparent; box-shadow:none; padding:.5rem .6rem; width:100%;
      color:#fff; border:none; outline:none;
    }
    .ms .dropdown {
      position:absolute; left:0; right:0; top:110%;
      background:rgba(20,0,40,.95); border:1px solid rgba(255,255,255,.08);
      border-radius:12px; box-shadow:0 18px 34px rgba(180,107,255,.25);
      max-height:220px; overflow:auto; z-index:50; display:none;
    }
    .ms .dropdown.open { display:block; }
    .ms .opt { padding:10px 12px; cursor:pointer; display:flex; justify-content:space-between; gap:10px; }
    .ms .opt:hover { background:rgba(255,255,255,.08); }

    .file-row { display:flex; align-items:center; gap:12px; margin:8px 0 4px; }
    .preview {
      display:flex; align-items:center; gap:10px;
      background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.06);
      padding:10px; border-radius:12px; margin-top:6px;
    }
    .preview img { width:86px; height:86px; object-fit:cover; border-radius:10px; box-shadow:0 0 12px rgba(180,107,255,.35); }
    .preview .fileinfo { font-size:.95rem; opacity:.9; }

    .btn {
      background:linear-gradient(90deg,#9b4dff,#b86bff);
      border:none; border-radius:10px; color:#fff; font-weight:600;
      padding:8px 14px; cursor:pointer; transition:.2s; box-shadow:0 0 10px rgba(180,107,255,.25);
    }
    .btn:hover { transform:translateY(-1px); box-shadow:0 10px 22px rgba(180,107,255,.35); }
    .btn-soft { background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.08); }
    .btn-danger{ background:linear-gradient(90deg,#ff4d6d,#ff7c6b); }

    /* Toast */
    .aura-toast{
      position:fixed; right:16px; bottom:16px; z-index:1200; display:flex; gap:10px; align-items:center;
      background:rgba(20,0,40,.95); border:1px solid rgba(255,255,255,.08);
      padding:.7rem 1rem; border-radius:12px; color:#fff; box-shadow:0 10px 24px rgba(180,107,255,.35);
      animation:fadeIn .15s ease;
    }
    .aura-toast.success{ border-color:rgba(140,255,199,.35); }
    .aura-toast.error{ border-color:rgba(255,124,107,.35); }
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}

    /* Modal */
    .aura-modal-wrap{ position:fixed; inset:0; background:rgba(0,0,0,.55); display:flex; align-items:center; justify-content:center; padding:20px; z-index:1400; animation:fadeIn .15s ease;}
    .aura-modal{ width:min(520px,95vw); background:rgba(20,0,40,.92); border:1px solid rgba(255,255,255,.08); border-radius:16px; padding:18px; color:#fff; box-shadow:0 18px 40px rgba(180,107,255,.35);}
    .aura-modal h3{ margin:0 0 6px; }
    .aura-modal p{ margin:.25rem 0 1rem; opacity:.9;}
    .aura-modal .row{ display:flex; gap:10px; justify-content:flex-end;}
    .aura-btn{ background:rgba(255,255,255,.08); color:#fff; border:1px solid rgba(255,255,255,.08); padding:.6rem .9rem; border-radius:10px; cursor:pointer; font-weight:600;}
    .aura-btn.primary{ background: linear-gradient(135deg,#b46bff,#9f4dff); border:none;}
    .aura-btn.danger{ background: linear-gradient(135deg,#ff4d6d,#ff7c6b); border:none;}

    .hidden{display:none}
  </style>
</head>

<body>
  <!-- SIDEBAR (sem "Agente:") -->
  <div class="sidebar">
    <h2 class="logo">SISTEMA AURA</h2>
    <ul>
      <li><a href="../dashboard.html" class="navlink"><span class="icon">üè†</span><span class="label">Dashboard</span></a></li>
      <li><a href="../perfis/ver.html" class="navlink"><span class="icon">üëë</span><span class="label">Perfil da Aura</span></a></li>
      <li><a href="ver.html" class="navlink"><span class="icon">üìÅ</span><span class="label">Casos</span></a></li>
      <li><a href="arquivados.html" class="navlink"><span class="icon">üóÉÔ∏è</span><span class="label">Arquivados</span></a></li>
    </ul>
    <button id="logoutBtn">Sair</button>
  </div>

  <!-- CONTE√öDO -->
  <div class="main-content">
    <div class="page-container">
      <div class="topbar">
        <h1>Editar Caso</h1>
        <div class="row-actions">
          <button id="backBtn" class="btn btn-soft">‚¨ÖÔ∏è Voltar</button>
          <button id="archiveBtn" class="btn btn-soft only-editor">üì¶ Arquivar</button>
          <button id="reopenBtn"  class="btn btn-soft only-editor hidden">üóÉ Reabrir</button>
          <button id="deleteBtn"  class="btn btn-danger only-editor">üóë Eliminar</button>
          <button id="saveBtn"    class="btn only-editor">üíæ Guardar</button>
        </div>
      </div>

      <form id="caseForm" class="card">
        <label>T√≠tulo</label>
        <input id="titulo" placeholder="Ex: Opera√ß√£o Eclipse" required />

        <label>Respons√°vel</label>
        <input id="responsavel" placeholder="Ex: Agente Solano" />

        <!-- Envolvidos -->
        <div class="ms" id="ms-envolvidos">
          <label>Envolvidos</label>
          <div class="box">
            <div class="chips"></div>
            <div class="input-wrap">
              <input type="text" placeholder="Pesquisar pessoas..." />
              <div class="dropdown"></div>
            </div>
          </div>
        </div>

        <!-- Ve√≠culos -->
        <div class="ms" id="ms-veiculos">
          <label>Ve√≠culos (opcional)</label>
          <div class="box">
            <div class="chips"></div>
            <div class="input-wrap">
              <input type="text" placeholder="Pesquisar ve√≠culos..." />
              <div class="dropdown"></div>
            </div>
          </div>
        </div>

        <!-- Fac√ß√µes -->
        <div class="ms" id="ms-faccoes">
          <label>Fac√ß√µes (opcional)</label>
          <div class="box">
            <div class="chips"></div>
            <div class="input-wrap">
              <input type="text" placeholder="Pesquisar fac√ß√µes..." />
              <div class="dropdown"></div>
            </div>
          </div>
        </div>

        <label>Descri√ß√£o</label>
        <textarea id="descricao" placeholder="Detalhes do caso..."></textarea>

        <label>Anexo (imagem ou PDF)</label>
        <div class="file-row">
          <input id="fileInput" type="file" accept="image/*,.pdf"/>
          <button id="removeFileBtn" type="button" class="btn btn-soft hidden">Remover anexo</button>
        </div>
        <div id="filePreview" class="preview" style="display:none;"></div>
      </form>
    </div>
  </div>

  <!-- FIREBASE -->
  <script type="module">
    import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import {
      getFirestore, doc, getDoc, updateDoc, deleteDoc, collection, getDocs, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";
    import {
      getStorage, ref, uploadBytes, getDownloadURL, deleteObject
    } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-storage.js";
    import { firebaseConfig } from "../firebaseConfig.js";

    const app = getApps().length ? getApps()[0] : initializeApp(firebaseConfig);
    const db  = getFirestore(app);
    const stg = getStorage(app);

    const qs = new URLSearchParams(location.search);
    const id = qs.get("id");
    if(!id) location.href = "ver.html";

    // Elements
    const tituloEl = document.getElementById("titulo");
    const responsavelEl = document.getElementById("responsavel");
    const descricaoEl = document.getElementById("descricao");
    const archiveBtn = document.getElementById("archiveBtn");
    const reopenBtn  = document.getElementById("reopenBtn");
    const deleteBtn  = document.getElementById("deleteBtn");
    const saveBtn    = document.getElementById("saveBtn");
    const backBtn    = document.getElementById("backBtn");

    const fileInput  = document.getElementById("fileInput");
    const filePreview= document.getElementById("filePreview");
    const removeFileBtn = document.getElementById("removeFileBtn");

    // Toast
    function toast(msg,type="success"){
      const t=document.createElement("div");
      t.className=`aura-toast ${type}`;
      t.innerHTML=`<span>${type==="success"?"‚úÖ":"‚ö†Ô∏è"}</span><span>${msg}</span>`;
      document.body.appendChild(t);
      setTimeout(()=>{ t.style.opacity="0"; setTimeout(()=>t.remove(),260); }, 1900);
    }
    // Modal
    function confirmModal({title="Confirmar", message="Tens a certeza?", okText="Confirmar", variant="primary"}){
      return new Promise(resolve=>{
        const wrap=document.createElement("div");
        wrap.className="aura-modal-wrap";
        wrap.innerHTML=`
          <div class="aura-modal">
            <h3>${title}</h3>
            <p>${message}</p>
            <div class="row">
              <button class="aura-btn">Cancelar</button>
              <button class="aura-btn ${variant==='danger'?'danger':'primary'}">${okText}</button>
            </div>
          </div>`;
        document.body.appendChild(wrap);
        const [c,o]=wrap.querySelectorAll("button");
        const close=v=>{ wrap.remove(); resolve(v); };
        c.onclick=()=>close(false); o.onclick=()=>close(true);
        wrap.addEventListener("click",(e)=>{ if(e.target===wrap) close(false); });
      });
    }

    // Chips helper
    function makeChipSelect(rootEl, options){
      const chipsEl = rootEl.querySelector(".chips");
      const inputEl = rootEl.querySelector("input");
      const ddEl    = rootEl.querySelector(".dropdown");
      const selected = [];

      function renderChips(){
        chipsEl.innerHTML = "";
        selected.forEach((lbl, idx)=>{
          const chip = document.createElement("span");
          chip.className="chip";
          chip.innerHTML = `${lbl} <button type="button">&times;</button>`;
          chip.querySelector("button").onclick = ()=>{ selected.splice(idx,1); renderChips(); };
          chipsEl.appendChild(chip);
        });
      }
      function openDD(filter=""){
        ddEl.classList.add("open");
        const f = filter.toLowerCase().trim();
        const avail = options
          .map(o => (typeof o==="string" ? o : (o.label || o.name || o.titulo || o.modelo || o.placa || "")))
          .filter(lbl => lbl && !selected.includes(lbl) && (!f || lbl.toLowerCase().includes(f)));
        ddEl.innerHTML = avail.length ? "" : `<div class="opt">Sem resultados‚Ä¶</div>`;
        avail.forEach(lbl=>{
          const opt=document.createElement("div");
          opt.className="opt";
          opt.innerHTML = `<span>${lbl}</span>`;
          opt.onclick = ()=>{ selected.push(lbl); renderChips(); inputEl.value=""; closeDD(); };
          ddEl.appendChild(opt);
        });
      }
      function closeDD(){ ddEl.classList.remove("open"); }

      inputEl.addEventListener("focus", ()=> openDD(inputEl.value));
      inputEl.addEventListener("input", ()=> openDD(inputEl.value));
      document.addEventListener("click", (e)=>{ if(!rootEl.contains(e.target)) closeDD(); });

      return {
        getSelected: ()=> [...selected],
        setOptions: (ops)=>{ options = ops || []; },
        setSelected: (labels=[])=>{ selected.splice(0,selected.length,...labels); renderChips(); }
      };
    }

    // Inst√¢ncias dos tr√™s selects
    const msEnvolvidos = makeChipSelect(document.getElementById("ms-envolvidos"), []);
    const msVeiculos   = makeChipSelect(document.getElementById("ms-veiculos"), []);
    const msFaccoes    = makeChipSelect(document.getElementById("ms-faccoes"), []);

    // Preload de listas (users+people / veiculos / facc)
    function labelFrom(docData, fallbackId){
      return (
        docData.name ||
        docData.titulo ||
        docData.modelo ||
        docData.placa ||
        docData.alias ||
        docData.code ||
        fallbackId
      );
    }
    async function loadOptions(){
      try{
        const [usersSnap, peopleSnap] = await Promise.all([
          getDocs(collection(db,"users")),
          getDocs(collection(db,"people"))
        ]);
        const envolv = [
          ...usersSnap.docs.map(d=>labelFrom(d.data(), d.id)),
          ...peopleSnap.docs.map(d=>labelFrom(d.data(), d.id)),
        ].filter(Boolean).sort((a,b)=>a.localeCompare(b));
        msEnvolvidos.setOptions(envolv);
      }catch(e){ console.warn("Erro a carregar envolvidos", e); }

      try{
        const vSnap = await getDocs(collection(db,"veiculos"));
        const vOps  = vSnap.docs.map(d=>labelFrom(d.data(), d.id)).filter(Boolean).sort((a,b)=>a.localeCompare(b));
        msVeiculos.setOptions(vOps);
      }catch(e){ msVeiculos.setOptions([]); }

      try{
        const fSnap = await getDocs(collection(db,"facc"));
        const fOps  = fSnap.docs.map(d=>labelFrom(d.data(), d.id)).filter(Boolean).sort((a,b)=>a.localeCompare(b));
        msFaccoes.setOptions(fOps);
      }catch(e){ msFaccoes.setOptions([]); }
    }

    // Permiss√µes
    const isAdmin = localStorage.getItem("isAdmin")==="true";
    const uRole   = (localStorage.getItem("userRole")||"").toLowerCase();
    const canEdit = isAdmin || uRole==="investigador";
    if(!canEdit){
      document.querySelectorAll(".only-editor").forEach(el=>el.style.display="none");
      document.querySelectorAll("input, textarea").forEach(el=>el.disabled=true);
    }

    backBtn.onclick = ()=> window.location.href="ver.html";

    // Preview ficheiro local
    fileInput.addEventListener("change", ()=>{
      const f=fileInput.files?.[0];
      if(!f){ filePreview.style.display="none"; filePreview.innerHTML=""; return; }
      filePreview.style.display="flex";
      if(f.type.startsWith("image/")){
        const url=URL.createObjectURL(f);
        filePreview.innerHTML = `<img src="${url}" alt="preview"><span class="fileinfo">${f.name} ‚Ä¢ ${(f.size/1024).toFixed(1)} KB</span>`;
      }else{
        filePreview.innerHTML = `<span class="fileinfo">üìÑ ${f.name} ‚Ä¢ ${(f.size/1024).toFixed(1)} KB</span>`;
      }
      removeFileBtn.classList.add("hidden"); // estamos a trocar por um novo
    });

    // Carregar caso
    let currentData = null;
    let currentFileURL = null; // photoURL existente
    let currentFilePath = null; // path aproximado no storage (se conseguirmos inferir)
    async function loadCase(){
      await loadOptions();
      const snap = await getDoc(doc(db,"casos",id));
      if(!snap.exists()){ toast("Caso n√£o encontrado.","error"); setTimeout(()=>location.href="ver.html",900); return; }
      currentData = snap.data();

      tituloEl.value = currentData.titulo || "";
      responsavelEl.value = currentData.responsavel || "";
      descricaoEl.value = currentData.descricao || "";

      // estado ‚Üí alternar bot√µes
      const estado = (currentData.estado || "ativo").toLowerCase();
      if(estado==="arquivado"){
        archiveBtn.classList.add("hidden");
        reopenBtn.classList.remove("hidden");
      } else {
        archiveBtn.classList.remove("hidden");
        reopenBtn.classList.add("hidden");
      }

      // chips
      msEnvolvidos.setSelected(currentData.envolvidos || []);
      msVeiculos.setSelected(currentData.veiculos || []);
      msFaccoes.setSelected(currentData.faccoes || []);

      // anexo existente
      if(currentData.photoURL){
        currentFileURL = currentData.photoURL;
        filePreview.style.display="flex";
        const isImg = /\.(png|jpe?g|gif|webp|bmp|svg)$/i.test(currentFileURL);
        if(isImg){
          filePreview.innerHTML = `<img src="${currentFileURL}" alt="anexo"><span class="fileinfo">${currentData.fileName || "imagem"}</span>`;
        } else {
          filePreview.innerHTML = `<span class="fileinfo">üìÑ ${currentData.fileName || "documento"}<br><a href="${currentFileURL}" target="_blank" style="color:#bfa7ff; text-decoration:underline;">Abrir</a></span>`;
        }
        removeFileBtn.classList.remove("hidden");
      }
    }

    // Remover anexo atual (apenas do doc; se quiseres tamb√©m apagar do Storage, tentamos)
    removeFileBtn.addEventListener("click", async ()=>{
      if(!canEdit){ toast("Sem permiss√£o.","error"); return; }
      const ok = await confirmModal({ title:"Remover anexo", message:"Desejas remover o anexo deste caso?", okText:"Remover", variant:"danger" });
      if(!ok) return;
      try{
        // tentativa de apagar do storage se conseguirmos inferir o path
        // (como grav√°mos `casos/{id}/{timestamp_nome}`, podemos tentar parsear pelo URL do storage,
        // mas como o getDownloadURL √© assinado, nem sempre d√°. Vamos ao seguro: s√≥ limpamos o doc.)
        await updateDoc(doc(db,"casos",id), { photoURL:"", fileName:"", fileType:"" });
        currentFileURL = null;
        fileInput.value = "";
        filePreview.style.display="none";
        filePreview.innerHTML = "";
        removeFileBtn.classList.add("hidden");
        toast("Anexo removido.");
      }catch(e){ console.error(e); toast("Erro ao remover anexo: "+e.message,"error"); }
    });

    // Guardar altera√ß√µes
    saveBtn?.addEventListener("click", async (e)=>{
      e.preventDefault();
      if(!canEdit){ toast("Sem permiss√£o para guardar.","error"); return; }

      const ok = await confirmModal({ title:"Guardar altera√ß√µes", message:"Confirmas guardar as altera√ß√µes deste caso?", okText:"Guardar" });
      if(!ok) return;

      try{
        const update = {
          titulo: (tituloEl.value||"").trim(),
          responsavel: (responsavelEl.value||"").trim(),
          envolvidos: msEnvolvidos.getSelected(),
          veiculos: msVeiculos.getSelected(),
          faccoes: msFaccoes.getSelected(),
          descricao: (descricaoEl.value||"").trim(),
          updatedAt: serverTimestamp()
        };

        // se houver novo ficheiro, fazemos upload e atualizamos o doc
        const f = fileInput.files?.[0];
        if(f){
          const safeName = f.name.replace(/[^\w.\-]+/g,"_");
          const path = `casos/${id}/${Date.now()}_${safeName}`;
          const sref = ref(stg, path);
          await uploadBytes(sref, f);
          const url = await getDownloadURL(sref);
          update.photoURL = url;
          update.fileName = f.name;
          update.fileType = f.type || "";
        }

        await updateDoc(doc(db,"casos",id), update);
        toast("Altera√ß√µes guardadas!");
      }catch(e){
        console.error(e);
        toast("Erro ao guardar: "+e.message, "error");
      }
    });

    // Arquivar
    archiveBtn?.addEventListener("click", async ()=>{
      if(!canEdit){ toast("Sem permiss√£o.","error"); return; }
      const ok = await confirmModal({ title:"Arquivar caso", message:"Queres arquivar este caso?", okText:"Arquivar" });
      if(!ok) return;
      try{
        await updateDoc(doc(db,"casos",id), { estado:"arquivado", updatedAt: serverTimestamp() });
        toast("Caso arquivado!");
        archiveBtn.classList.add("hidden");
        reopenBtn.classList.remove("hidden");
      }catch(e){ console.error(e); toast("Erro ao arquivar: "+e.message,"error"); }
    });

    // Reabrir
    reopenBtn?.addEventListener("click", async ()=>{
      if(!canEdit){ toast("Sem permiss√£o.","error"); return; }
      const ok = await confirmModal({ title:"Reabrir caso", message:"Desejas reabrir este caso?", okText:"Reabrir" });
      if(!ok) return;
      try{
        await updateDoc(doc(db,"casos",id), { estado:"ativo", updatedAt: serverTimestamp() });
        toast("Caso reaberto!");
        reopenBtn.classList.add("hidden");
        archiveBtn.classList.remove("hidden");
      }catch(e){ console.error(e); toast("Erro ao reabrir: "+e.message,"error"); }
    });

    // Eliminar
    deleteBtn?.addEventListener("click", async ()=>{
      if(!canEdit){ toast("Sem permiss√£o.","error"); return; }
      const ok = await confirmModal({ title:"Eliminar caso", message:"Esta a√ß√£o √© permanente. Queres eliminar este caso?", okText:"Eliminar", variant:"danger" });
      if(!ok) return;
      try{
        // tentativa opcional: remover ficheiro principal (n√£o temos path exato; manter simples ‚Üí s√≥ doc)
        await deleteDoc(doc(db,"casos",id));
        toast("Caso eliminado!");
        setTimeout(()=> location.href="ver.html", 900);
      }catch(e){ console.error(e); toast("Erro ao eliminar: "+e.message, "error"); }
    });

    // start
    loadCase();
  </script>

  <!-- LOGOUT -->
  <script>
    (function(){
      const logoutBtn=document.getElementById("logoutBtn");
      if(logoutBtn) logoutBtn.onclick=()=>{
        ["username","selectedAgent","userRole","userCode","isAdmin"].forEach(k=>localStorage.removeItem(k));
        window.location.href="../select.html";
      };
    })();
  </script>
</body>
</html>
