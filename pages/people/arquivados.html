<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Casos Arquivados - Sistema Aura</title>
  <link rel="icon" href="../../Aurinha.png" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;500;700&display=swap" rel="stylesheet" />
  <style>
    body {
      background: radial-gradient(circle at top left,#1a001f,#000);
      font-family: 'Poppins', sans-serif;
      color:#fff;
      margin:0;
      padding:30px;
    }

    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .top-bar h2 {
      color:#d6b2ff;
      text-shadow:0 0 10px rgba(180,0,255,0.7);
      margin: 0;
      flex:1;
      text-align:center;
    }

    .top-bar button {
      background: linear-gradient(90deg,#9b4dff,#b86bff);
      border: none;
      border-radius: 10px;
      color: #fff;
      font-weight: 600;
      padding: 8px 16px;
      cursor: pointer;
      transition: 0.3s;
      box-shadow: 0 0 10px rgba(180,0,255,0.4);
    }

    .top-bar button:hover {
      transform: scale(1.05);
      background: linear-gradient(90deg,#b86bff,#d6aaff);
      box-shadow: 0 0 15px rgba(180,0,255,0.6);
    }

    #searchBar {
      display:block;
      margin:0 auto 30px;
      width:300px;
      padding:10px;
      border:none;
      border-radius:10px;
      background:rgba(255,255,255,0.1);
      color:#fff;
      text-align:center;
    }

    #searchBar:focus {
      outline:none;
      box-shadow:0 0 10px rgba(180,0,255,0.6);
      background:rgba(255,255,255,0.15);
    }

    .grid {
      display:grid;
      grid-template-columns:repeat(auto-fill,minmax(220px,1fr));
      gap:20px;
    }

    .card {
      background:rgba(50,0,80,0.45);
      border:1px solid rgba(200,150,255,0.3);
      border-radius:20px;
      padding:15px;
      box-shadow:0 0 20px rgba(180,0,255,0.3);
      transition:all .3s ease;
      overflow:hidden;
      position:relative;
    }

    .card.expanded {
      grid-column:span 2;
      box-shadow:0 0 30px rgba(200,150,255,0.7);
      background:rgba(70,0,110,0.7);
    }

    .card h3 {
      margin:0 0 5px;
      color:#d6b2ff;
      font-weight:600;
    }

    .card p {
      font-size:0.85rem;
      line-height:1.3;
      margin:3px 0;
    }

    .card .desc {
      color:#ccc;
      margin:5px 0;
    }

    .buttons {
      margin-top:10px;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .buttons button {
      background:linear-gradient(90deg,#9b4dff,#b86bff);
      border:none;
      border-radius:8px;
      color:#fff;
      padding:5px 10px;
      cursor:pointer;
      transition:.3s;
      flex: 1;
      min-width: 100px;
    }

    .buttons button:hover {
      transform:scale(1.05);
      background:linear-gradient(90deg,#b86bff,#d6aaff);
    }

    .fullDesc {
      margin-top:10px;
      color:#eee;
      font-size:0.9rem;
      text-align:left;
      animation:fadeIn .3s ease;
    }

    @keyframes fadeIn{from{opacity:0;transform:translateY(-5px);}to{opacity:1;transform:translateY(0);}}

    /* Popup neon */
    .neon-popup {
      position: fixed;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%);
      background: linear-gradient(90deg, #9b4dff, #b86bff);
      padding: 12px 25px;
      border-radius: 15px;
      color: #fff;
      font-weight: 500;
      box-shadow: 0 0 20px rgba(180,0,255,0.6);
      text-align: center;
      z-index: 9999;
      animation: fadeInUp 0.3s ease;
    }

    .neon-popup.error {
      background: linear-gradient(90deg, #ff3b3b, #ff6b6b);
      box-shadow: 0 0 25px rgba(255,0,90,0.7);
    }

    @keyframes fadeInUp {
      from {opacity:0; transform: translate(-50%, 10px);}
      to {opacity:1; transform: translate(-50%, 0);}
    }

    /* Modal de confirma√ß√£o */
    .confirm-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      animation: fadeIn .3s ease;
    }

    .confirm-box {
      background: rgba(40,0,60,0.95);
      border: 1px solid rgba(200,150,255,0.4);
      border-radius: 15px;
      padding: 25px;
      text-align: center;
      box-shadow: 0 0 25px rgba(180,0,255,0.7);
      width: 300px;
      animation: fadeInUp .3s ease;
    }

    .confirm-box h3 {
      color: #d6b2ff;
      margin-bottom: 15px;
    }

    .confirm-buttons {
      display: flex;
      justify-content: space-around;
      margin-top: 20px;
    }

    .confirm-buttons button {
      background: linear-gradient(90deg,#9b4dff,#b86bff);
      border: none;
      border-radius: 8px;
      color: #fff;
      padding: 8px 20px;
      cursor: pointer;
      transition: .3s;
    }

    .confirm-buttons button:hover {
      transform: scale(1.05);
      background: linear-gradient(90deg,#b86bff,#d6aaff);
    }

    .confirm-buttons .cancel {
      background: linear-gradient(90deg,#444,#666);
    }
  </style>
</head>
<body>
  <div class="top-bar">
    <button id="backBtn">‚¨Ö Voltar</button>
    <h2>Casos Arquivados</h2>
    <div style="width:120px;"></div>
  </div>

  <input type="text" id="searchBar" placeholder="üîç Pesquisar por c√≥digo ou t√≠tulo..." />
  <div class="grid" id="casesGrid"></div>

  <script type="module">
    import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import { getFirestore, collection, getDocs, query, orderBy, doc, setDoc, deleteDoc } 
      from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";
    import { firebaseConfig } from "../../firebaseConfig.js";

    const app = getApps().length===0 ? initializeApp(firebaseConfig):getApps()[0];
    const db = getFirestore(app);
    const grid=document.getElementById("casesGrid");
    const search=document.getElementById("searchBar");
    let allCases=[];

    document.getElementById("backBtn").addEventListener("click", () => {
      window.location.href = "../../dashboard.html";
    });

    // Popup neon
    function showNeonMessage(msg, isError = false) {
      const popup = document.createElement("div");
      popup.className = `neon-popup ${isError ? 'error' : ''}`;
      popup.textContent = msg;
      document.body.appendChild(popup);
      setTimeout(() => popup.remove(), 3000);
    }

    // Modal neon
    function showConfirmModal(message, onConfirm) {
      const overlay = document.createElement("div");
      overlay.className = "confirm-overlay";
      overlay.innerHTML = `
        <div class="confirm-box">
          <h3>${message}</h3>
          <div class="confirm-buttons">
            <button class="confirm">Confirmar</button>
            <button class="cancel">Cancelar</button>
          </div>
        </div>`;
      document.body.appendChild(overlay);

      overlay.querySelector(".confirm").addEventListener("click", () => {
        overlay.remove();
        onConfirm();
      });
      overlay.querySelector(".cancel").addEventListener("click", () => overlay.remove());
    }

    async function loadCases(){
      const q=query(collection(db,"cases_archived"),orderBy("archivedAt","desc"));
      const snap=await getDocs(q);
      allCases=snap.docs.map(d=>({id:d.id,...d.data()}));
      renderCases(allCases);
    }

    function renderCases(cases){
      grid.innerHTML="";
      if(!cases.length){grid.innerHTML="<p style='text-align:center;opacity:0.7'>Nenhum caso arquivado.</p>";return;}
      cases.forEach(c=>{
        const shortDesc=c.description?.length>100?c.description.substring(0,100)+"...":c.description||"Sem descri√ß√£o";
        const card=document.createElement("div");
        card.className="card";
        card.innerHTML=`
          <h3>${c.code||"C-??"} ‚Äî ${c.title||"Sem t√≠tulo"}</h3>
          <p><b>Suspeito:</b> ${c.suspect||"‚Äî"}</p>
          <p><b>Fac√ß√£o:</b> ${c.faction||"‚Äî"}</p>
          <p><b>Ve√≠culo:</b> ${c.vehicle||"‚Äî"}</p>
          <p><b>Arquivado em:</b> ${c.archivedAt?.toDate?c.archivedAt.toDate().toLocaleDateString():"‚Äî"}</p>
          <p class="desc">${shortDesc}</p>
          <div class="buttons">
            <button class="viewBtn">üëÅ Ver Detalhes</button>
            <button class="restoreBtn">‚ôªÔ∏è Restaurar</button>
          </div>
        `;

        const viewBtn=card.querySelector(".viewBtn");
        const restoreBtn=card.querySelector(".restoreBtn");

        viewBtn.addEventListener("click",()=>{
          if(card.classList.contains("expanded")){
            card.classList.remove("expanded");
            const full=card.querySelector(".fullDesc");
            if(full)full.remove();
            viewBtn.textContent="üëÅ Ver Detalhes";
          }else{
            card.classList.add("expanded");
            const full=document.createElement("div");
            full.className="fullDesc";
            full.innerHTML=`
              <p><b>Descri√ß√£o Completa:</b><br>${c.description||"Sem descri√ß√£o detalhada."}</p>
              <button class="closeBtn">‚¨Ö Fechar</button>`;
            card.appendChild(full);
            full.querySelector(".closeBtn").addEventListener("click",()=>{
              card.classList.remove("expanded");
              full.remove();
              viewBtn.textContent="üëÅ Ver Detalhes";
            });
            viewBtn.textContent="‚¨Ö Fechar";
          }
        });

        restoreBtn.addEventListener("click", () => {
          showConfirmModal("‚ôªÔ∏è Desejas restaurar este caso?", async () => {
            try {
              const archivedRef = doc(db, "cases_archived", c.id);
              const activeRef = doc(db, "cases", c.id);
              await setDoc(activeRef, { ...c, restoredAt: new Date() }, { merge: true });
              await deleteDoc(archivedRef);
              showNeonMessage("‚úÖ Caso restaurado com sucesso!");
              card.remove();
            } catch (err) {
              console.error(err);
              showNeonMessage("‚ùå Erro ao restaurar caso!", true);
            }
          });
        });

        grid.appendChild(card);
      });
    }

    search.addEventListener("input",()=>{
      const term=search.value.toLowerCase();
      const filtered=allCases.filter(c=>
        (c.code||"").toLowerCase().includes(term) ||
        (c.title||"").toLowerCase().includes(term)
      );
      renderCases(filtered);
    });

    loadCases();
  </script>
</body>
</html>
