<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gerenciar FacÃ§Ãµes - Sistema AURA</title>
  <link rel="icon" href="../Aurinha.png" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;500;700&display=swap" rel="stylesheet" />
  <style>
    body {
      background: radial-gradient(circle at top left,#1a001f,#000);
      font-family: 'Poppins', sans-serif;
      color: #fff;
      margin: 0;
      padding: 30px;
    }
    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: relative;
    }
    .top-bar h2 {
      flex: 1;
      text-align: center;
      color: #d6b2ff;
      font-size: 1.8rem;
      text-shadow: 0 0 12px rgba(180,0,255,0.6);
      margin: 0;
    }
    .back-btn, .right-buttons button {
      background: linear-gradient(90deg,#9b4dff,#b86bff);
      border: none;
      border-radius: 8px;
      color: #fff;
      font-weight: 600;
      padding: 6px 14px;
      cursor: pointer;
      transition: .3s;
      box-shadow: 0 0 10px rgba(180,0,255,0.4);
    }
    .back-btn:hover, .right-buttons button:hover {
      transform: scale(1.05);
      background: linear-gradient(90deg,#b86bff,#d6aaff);
    }
    .back-btn { position: absolute; left: 0; top: 0; }
    .right-buttons { position: absolute; right: 0; top: 0; display: flex; gap: 10px; }
    #searchBar {
      display: block;
      margin: 70px auto 30px;
      width: 320px;
      padding: 10px;
      border: none;
      border-radius: 10px;
      background: rgba(255,255,255,0.1);
      color: #fff;
      text-align: center;
    }
    #searchBar:focus { outline: none; box-shadow: 0 0 10px rgba(180,0,255,0.6); }
    .faction-card {
      background: rgba(50,0,80,0.45);
      border: 1px solid rgba(200,150,255,0.3);
      border-radius: 16px;
      padding: 20px;
      margin: 20px auto;
      max-width: 900px;
      box-shadow: 0 0 20px rgba(180,0,255,0.2);
      position: relative;
    }
    .faction-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    .faction-name { font-size: 1.4rem; font-weight: 600; color: #d6b2ff; }
    .faction-img {
      width: 50px; height: 50px;
      border-radius: 8px;
      object-fit: cover;
      border: 1px solid rgba(200,150,255,0.5);
      cursor: pointer;
    }
    .member-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 10px; margin-top: 10px;
    }
    .member-card {
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(180,0,255,0.2);
      border-radius: 10px;
      padding: 8px 10px;
      font-size: 0.9rem;
    }
    .base-photos {
      display: flex; overflow-x: auto; gap: 10px; margin-top: 15px;
    }
    .base-photos img {
      width: 120px; height: 80px; border-radius: 8px; object-fit: cover;
      cursor: pointer; border: 1px solid rgba(200,150,255,0.4);
    }
    .buttons {
      display: flex; justify-content: flex-end; gap: 8px; margin-top: 15px;
    }
    .buttons button {
      background: linear-gradient(90deg,#9b4dff,#b86bff);
      border: none; border-radius: 8px;
      color: #fff; font-weight: 600; padding: 6px 14px;
      cursor: pointer; transition: .3s;
    }
    .buttons button:hover { transform: scale(1.05); background: linear-gradient(90deg,#b86bff,#d6aaff); }
    .popup {
      position: fixed; bottom: 30px; left: 50%;
      transform: translateX(-50%);
      background: linear-gradient(90deg,#9b4dff,#b86bff);
      padding: 12px 25px; border-radius: 15px; color: #fff;
      box-shadow: 0 0 20px rgba(180,0,255,0.6);
      animation: fadeInUp .3s ease; z-index: 9999;
    }
    @keyframes fadeInUp { from{opacity:0;transform:translate(-50%,10px);} to{opacity:1;transform:translate(-50%,0);} }
    .modal {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.85); display: flex; align-items: center; justify-content: center;
      flex-direction: column; z-index: 10000;
    }
    .modal img {
      max-width: 80%; max-height: 80%; border-radius: 10px;
      box-shadow: 0 0 20px rgba(180,0,255,0.5);
    }
    .close-modal {
      background: linear-gradient(90deg,#9b4dff,#b86bff);
      border: none; color: #fff; font-weight: 600; padding: 8px 16px;
      border-radius: 10px; margin-top: 15px; cursor: pointer;
    }
  </style>
</head>
<body>
  <div class="top-bar">
    <button class="back-btn" onclick="window.location.href='../dashboard.html'">â¬… Voltar</button>
    <h2>Gerenciar FacÃ§Ãµes</h2>
    <div class="right-buttons">
      <button id="archivedBtn">ðŸ“¦ Arquivadas</button>
      <button id="newBtn">+ Criar Nova</button>
    </div>
  </div>

  <input type="text" id="searchBar" placeholder="ðŸ” Pesquisar facÃ§Ã£o..." />
  <div id="factionList"></div>

  <script type="module">
    import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import { getFirestore, collection, getDocs, query, orderBy, addDoc, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";
    import { getStorage, ref, listAll, deleteObject } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-storage.js";
    import { firebaseConfig } from "../firebaseConfig.js";

    const app = getApps().length === 0 ? initializeApp(firebaseConfig) : getApps()[0];
    const db = getFirestore(app);
    const storage = getStorage(app);
    const factionList = document.getElementById("factionList");
    const searchBar = document.getElementById("searchBar");

    document.getElementById("newBtn").addEventListener("click",()=>window.location.href="criar.html");
    document.getElementById("archivedBtn").addEventListener("click",()=>window.location.href="faccoes_arquivadas.html");

    function popup(msg){
      const el=document.createElement("div");
      el.className="popup";
      el.textContent=msg;
      document.body.appendChild(el);
      setTimeout(()=>el.remove(),3000);
    }

    async function loadFactions(){
      const q=query(collection(db,"facc"),orderBy("name"));
      const snap=await getDocs(q);
      factionList.innerHTML="";
      if(snap.empty){ factionList.innerHTML="<p style='text-align:center;opacity:0.7'>Nenhuma facÃ§Ã£o encontrada.</p>"; return; }

      snap.forEach(async d=>{
        const f=d.data();
        const card=document.createElement("div");
        card.className="faction-card";

        const photo=f.faccPhotoURL||"https://cdn-icons-png.flaticon.com/512/685/685655.png";
        const membersSnap=await getDocs(collection(db,"people"));
        const members=[];
        membersSnap.forEach(p=>{ if(p.data().faction===f.name) members.push(p.data()); });

        let baseHTML="";
        if(f.basePhotos?.length){
          baseHTML=`<div class='base-photos'>${f.basePhotos.map(url=>`<img src='${url}' alt='Foto da Base'>`).join("")}</div>`;
        }

        card.innerHTML=`
          <div class='faction-header'>
            <div class='faction-name'>${f.name}</div>
            <img src='${photo}' class='faction-img'>
          </div>
          <div class='member-grid'>
            ${members.map(m=>`<div class='member-card'><strong>${m.name}</strong><br><span>${m.role||""}</span></div>`).join("")}
          </div>
          ${baseHTML}
          <div class='buttons'>
            <button class='editBtn'>ðŸ–Š Editar</button>
            <button class='archiveBtn'>ðŸ“¦ Arquivar</button>
            <button class='deleteBtn'>ðŸ—‘ Eliminar</button>
          </div>
        `;

        card.querySelector(".faction-img").addEventListener("click",()=>{
          if(!f.basePhotos?.length) return popup("âŒ Sem fotos da base!");
          const modal=document.createElement("div");
          modal.className="modal";
          modal.innerHTML=`
            ${f.basePhotos.map(u=>`<img src='${u}'>`).join("")}
            <button class='close-modal'>Fechar</button>
          `;
          document.body.appendChild(modal);
          modal.querySelector(".close-modal").addEventListener("click",()=>modal.remove());
        });

        card.querySelector(".editBtn").addEventListener("click",()=>window.location.href=`editar.html?id=${d.id}`);

        card.querySelector(".archiveBtn").addEventListener("click",async()=>{
          try{
            await addDoc(collection(db,"facc_archived"),{...f,archivedAt:new Date()});
            await deleteDoc(doc(db,"facc",d.id));
            popup("âœ… FacÃ§Ã£o arquivada!");
            card.remove();
          }catch(e){ popup("âŒ Erro ao arquivar!"); }
        });

        card.querySelector(".deleteBtn").addEventListener("click",async()=>{
          if(!confirm("ðŸ—‘ Tens certeza que queres eliminar esta facÃ§Ã£o?")) return;
          try{
            const baseRef=ref(storage,`facc_bases/${d.id}/`);
            const list=await listAll(baseRef);
            for(const item of list.items){ await deleteObject(item); }
            await deleteDoc(doc(db,"facc",d.id));
            popup("ðŸ—‘ FacÃ§Ã£o eliminada!");
            card.remove();
          }catch(e){ popup("âŒ Erro ao eliminar!"); console.error(e); }
        });

        factionList.appendChild(card);
      });
    }

    searchBar.addEventListener("input",()=>{
      const t=searchBar.value.toLowerCase();
      document.querySelectorAll(".faction-card").forEach(c=>{
        const name=c.querySelector(".faction-name").textContent.toLowerCase();
        c.style.display=name.includes(t)?"block":"none";
      });
    });

    loadFactions();
  </script>
</body>
</html>
